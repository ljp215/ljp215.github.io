
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Kafka Consumer 的实现 | Zane Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Jinping Luo">
    
    <meta name="description" content="说明: kafka 版本号为 0.11.0
Consumer 拉取消息的实现
在 Kafka Consumer 正常消费时，观察其调用堆栈。
1234567891011&quot;pool-16-thread-7&quot; #154 prio=5 os_prio=0 tid=0x00007ff581c8c000 ni">
    
    
    <meta name="description" content="说明: kafka 版本号为 0.11.0
Consumer 拉取消息的实现
在 Kafka Consumer 正常消费时，观察其调用堆栈。
1234567891011'pool-16-thread-7' #154 prio=5 os_prio=0 tid=0x00007ff581c8c000 nid=0x326d runnable [0x00007ff5468e7000]   java.lang">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka Consumer 的实现">
<meta property="og:url" content="http://luojinping.com/2017/11/12/Kafka-Consumer-的实现/">
<meta property="og:site_name" content="Zane Blog">
<meta property="og:description" content="说明: kafka 版本号为 0.11.0
Consumer 拉取消息的实现
在 Kafka Consumer 正常消费时，观察其调用堆栈。
1234567891011'pool-16-thread-7' #154 prio=5 os_prio=0 tid=0x00007ff581c8c000 nid=0x326d runnable [0x00007ff5468e7000]   java.lang">
<meta property="og:image" content="/img/kafka_consumer_state_in_server.png">
<meta property="og:image" content="/img/Kafka_Rebalance_Generation.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kafka Consumer 的实现">
<meta name="twitter:description" content="说明: kafka 版本号为 0.11.0
Consumer 拉取消息的实现
在 Kafka Consumer 正常消费时，观察其调用堆栈。
1234567891011'pool-16-thread-7' #154 prio=5 os_prio=0 tid=0x00007ff581c8c000 nid=0x326d runnable [0x00007ff5468e7000]   java.lang">


    
    <link rel="alternative" href="/atom.xml" title="Zane Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a2d87d3add52ff134d9fac6cc16e4800";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Zane Blog" title="Zane Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Zane Blog">Zane Blog</a></h1>
				<h2 class="blog-motto">业精于勤荒于嬉，形成思毁于随</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:luojinping.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/11/12/Kafka-Consumer-的实现/" title="Kafka Consumer 的实现" itemprop="url">Kafka Consumer 的实现</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2017-11-12T07:16:54.000Z" itemprop="datePublished"> Published Nov 12 2017</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer_拉取消息的实现"><span class="toc-number">1.</span> <span class="toc-text">Consumer 拉取消息的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Consumer_拉取消息的数量"><span class="toc-number">1.1.</span> <span class="toc-text">Consumer 拉取消息的数量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#poll_和_fetch_的关系"><span class="toc-number">1.1.1.</span> <span class="toc-text">poll 和 fetch 的关系</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer_的心跳机制"><span class="toc-number">2.</span> <span class="toc-text">Consumer 的心跳机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sessionTimeout"><span class="toc-number">2.1.</span> <span class="toc-text">sessionTimeout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pollTimeout"><span class="toc-number">2.2.</span> <span class="toc-text">pollTimeout</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Rebalance_Generation"><span class="toc-number">2.2.1.</span> <span class="toc-text">Rebalance Generation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#partition_的数量设置"><span class="toc-number">3.</span> <span class="toc-text">partition 的数量设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参数设置"><span class="toc-number">4.</span> <span class="toc-text">参数设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#heartbeat-interval-ms"><span class="toc-number">4.1.</span> <span class="toc-text">heartbeat.interval.ms</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参数值"><span class="toc-number">4.1.1.</span> <span class="toc-text">参数值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session-timeout-ms"><span class="toc-number">4.2.</span> <span class="toc-text">session.timeout.ms</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参数值-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">参数值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#max-poll-interval-ms"><span class="toc-number">4.3.</span> <span class="toc-text">max.poll.interval.ms</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#max-poll-records"><span class="toc-number">4.4.</span> <span class="toc-text">max.poll.records</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka_Javadoc_-_Detecting_Consumer_Failures"><span class="toc-number">5.</span> <span class="toc-text">Kafka Javadoc - Detecting Consumer Failures</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">6.</span> <span class="toc-text">Reference</span></a></li></ol>
		
		</div>
		
		<p><strong><em>说明: kafka 版本号为 0.11.0</em></strong></p>
<h2 id="Consumer_拉取消息的实现">Consumer 拉取消息的实现</h2>
<p>在 Kafka Consumer 正常消费时，观察其调用堆栈。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="string">"pool-16-thread-7"</span> <span class="comment">#154 prio=5 os_prio=0 tid=0x00007ff581c8c000 nid=0x326d runnable [0x00007ff5468e7000]</span></div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line">        <span class="keyword">...</span></div><div class="line">        at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:<span class="number">433</span>)</div><div class="line">        at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:<span class="number">232</span>)</div><div class="line">        - locked &lt;<span class="number">0x00000000c2e04f90</span>&gt; (a org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient)</div><div class="line">        at org.apache.kafka.clients.consumer.internals.ConsumerNetworkClient.poll(ConsumerNetworkClient.java:<span class="number">208</span>)</div><div class="line">        at org.apache.kafka.clients.consumer.KafkaConsumer.pollOnce(KafkaConsumer.java:<span class="number">1096</span>)</div><div class="line">        at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:<span class="number">1043</span>)</div><div class="line">        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.run(KafkaMessageListenerContainer.java:<span class="number">571</span>)</div><div class="line">        <span class="keyword">...</span></div></pre></td></tr></table></figure>

<p>对应的代码实现是 <code>org.apache.kafka.clients.consumer.KafkaConsumer#poll</code>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> ConsumerRecords&lt;K, V&gt; <span class="title">poll</span>(<span class="keyword">long</span> timeout) {</div><div class="line">        ...</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            ...</div><div class="line">            <span class="comment">// poll for new data until the timeout expires</span></div><div class="line">            <span class="keyword">long</span> start = time.milliseconds();</div><div class="line">            <span class="keyword">long</span> remaining = timeout;</div><div class="line">            do {</div><div class="line">                Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; records = pollOnce(remaining);</div><div class="line">                </div><div class="line">                <span class="keyword">if</span> (fetcher.sendFetches() &gt; <span class="number">0</span> || client.hasPendingRequests())</div><div class="line">                        client.pollNoWakeup();</div><div class="line">                        </div><div class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.interceptors == <span class="keyword">null</span>)</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ConsumerRecords&lt;&gt;(records);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.interceptors.onConsume(<span class="keyword">new</span> ConsumerRecords&lt;&gt;(records));</div><div class="line">                        </div><div class="line">                <span class="keyword">long</span> elapsed = time.milliseconds() - start;</div><div class="line">                remaining = timeout - elapsed;</div><div class="line">            } <span class="keyword">while</span> (remaining &gt; <span class="number">0</span>);</div><div class="line">            <span class="keyword">return</span> ConsumerRecords.empty();</div><div class="line">        } <span class="keyword">finally</span> {</div><div class="line">            release();</div><div class="line">        }</div><div class="line">    }</div></pre></td></tr></table></figure>

<p>其中 <code>org.apache.kafka.clients.consumer.KafkaConsumer#pollOnce</code>的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; <span class="title">pollOnce</span>(<span class="keyword">long</span> timeout) {</div><div class="line">        ...</div><div class="line">        <span class="comment">// ConsumerCoordinator coordinator;</span></div><div class="line">        coordinator.poll(time.milliseconds(), timeout);</div><div class="line">        ...</div><div class="line"></div><div class="line">        <span class="comment">// if data is available already, return it immediately</span></div><div class="line">        Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; records = fetcher.fetchedRecords();</div><div class="line">        <span class="keyword">if</span> (!records.isEmpty())</div><div class="line">            <span class="keyword">return</span> records;</div><div class="line"></div><div class="line">        <span class="comment">// send any new fetches (won't resend pending fetches)</span></div><div class="line">        fetcher.sendFetches();</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> fetcher.fetchedRecords();</div><div class="line">    }</div></pre></td></tr></table></figure>

<p>所以可以看到 consumer 每次 poll 时是先从 fetcher 中 fetchedRecords 的，如果拿不到结果，就新发起一个 sendFetches 请求。</p>
<h3 id="Consumer_拉取消息的数量">Consumer 拉取消息的数量</h3>
<p>在 <code>org.apache.kafka.clients.consumer.internals.Fetcher#fetchedRecords</code> 可以看到 <code>maxPollRecords</code>(max.poll.records 配置) 变量限制了每次 poll 的消息条数，不管 consumer 对应多少个 partition，从所有 partition 拉取到的消息条数总和不会超过 <code>maxPollRecords</code>。</p>
<p>在 <code>org.apache.kafka.clients.consumer.internals.Fetcher#sendFetches</code> 可以看到 <code>fetchSize</code>(max.partition.fetch.bytes 配置) 用于每次创建 FetchRequest 时的 <code>org.apache.kafka.common.requests.FetchRequest.PartitionData</code> 的参数设置。<code>fetchSize</code>限制了 consumer 每次从每个 partition 拉取的数据量。<br>不过，还是看代码中的 <code>ConsumerConfig#MAX_PARTITION_FETCH_BYTES_DOC</code> 说明吧：</p>
<blockquote>
<p>The maximum amount of data per-partition the server will return. Records are fetched in batches by the consumer. If the first record batch in the first non-empty partition of the fetch is larger than this limit, the batch will still be returned to ensure that the consumer can make progress. The maximum record batch size accepted by the broker is defined via <code>message.max.bytes</code> (broker config) or <code>max.message.bytes</code> (topic config). See “ + FETCH_MAX_BYTES_CONFIG + “ for limiting the consumer request size.</p>
</blockquote>
<h4 id="poll_和_fetch_的关系">poll 和 fetch 的关系</h4>
<p>在满足max.partition.fetch.bytes限制的情况下，假如fetch到了100个record，放到本地缓存后，由于max.poll.records限制每次只能poll出15个record。那么KafkaConsumer就需要执行7次才能将这一次通过网络发起的fetch请求所fetch到的这100个record消费完毕。其中前6次是每次pool中15个record，最后一次是poll出10个record。</p>
<h2 id="Consumer_的心跳机制">Consumer 的心跳机制</h2>
<p>在 <code>org.apache.kafka.clients.consumer.internals.AbstractCoordinat</code> 中启动 <code>HeartbeatThread</code> 线程来定时发送心跳和检查 consumer 的状态。<br>每个 Consumer 都有一个 ConsumerCoordinator(继承 AbstractCoordinator)，每个 ConsumerCoordinator 都启动一个 <code>HeartbeatThread</code> 线程来维护心跳，心跳信息存放在 <code>org.apache.kafka.clients.consumer.internals.Heartbeat</code>。</p>
<p>实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">                log.debug(<span class="string">"Heartbeat thread for group {} started"</span>, groupId);</div><div class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">                    <span class="keyword">synchronized</span> (AbstractCoordinator.<span class="keyword">this</span>) {</div><div class="line">                        ...</div><div class="line">                        client.pollNoWakeup();</div><div class="line">                        <span class="keyword">long</span> now = time.milliseconds();</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (coordinatorUnknown()) {</div><div class="line">                            ...</div><div class="line">                        } <span class="keyword">else</span> <span class="keyword">if</span> (heartbeat.sessionTimeoutExpired(now)) {</div><div class="line">                            <span class="comment">// the session timeout has expired without seeing a successful heartbeat, so we should</span></div><div class="line">                            <span class="comment">// probably make sure the coordinator is still healthy.</span></div><div class="line">                            coordinatorDead();</div><div class="line">                        } <span class="keyword">else</span> <span class="keyword">if</span> (heartbeat.pollTimeoutExpired(now)) {</div><div class="line">                            <span class="comment">// the poll timeout has expired, which means that the foreground thread has stalled</span></div><div class="line">                            <span class="comment">// in between calls to poll(), so we explicitly leave the group.</span></div><div class="line">                            maybeLeaveGroup();</div><div class="line">                        } <span class="keyword">else</span> <span class="keyword">if</span> (!heartbeat.shouldHeartbeat(now)) {</div><div class="line">                            <span class="comment">// poll again after waiting for the retry backoff in case the heartbeat failed or the</span></div><div class="line">                            <span class="comment">// coordinator disconnected</span></div><div class="line">                            AbstractCoordinator.<span class="keyword">this</span>.wait(retryBackoffMs);</div><div class="line">                        } <span class="keyword">else</span> {</div><div class="line">                            heartbeat.sentHeartbeat(now);</div><div class="line">                            ...</div><div class="line">                        }</div><div class="line">                  } <span class="comment">// end synchronized</span></div><div class="line">              } <span class="comment">// end while</span></div><div class="line">          } <span class="comment">//end try              </span></div><div class="line">} <span class="comment">// end run</span></div></pre></td></tr></table></figure>

<p>其中最重要的两个 timeout 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sessionTimeoutExpired</span>(<span class="keyword">long</span> now) {</div><div class="line">    <span class="keyword">return</span> now - Math.max(lastSessionReset, lastHeartbeatReceive) &gt; sessionTimeout;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">pollTimeoutExpired</span>(<span class="keyword">long</span> now) {</div><div class="line">    <span class="keyword">return</span> now - lastPoll &gt; maxPollInterval;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="sessionTimeout">sessionTimeout</h3>
<p>如果是 sessionTimeout 则 Mark the current coordinator as dead，此时  会将 consumer 踢掉，重新分配 partition 和 consumer 的对应关系。</p>
<p>在 Kafka Server 端，Consumer 的 Group 定义了五个状态：：<br><img src="/img/kafka_consumer_state_in_server.png" alt="Consumer Group State"></p>
<p>

<h3 id="pollTimeout">pollTimeout</h3>
</p><p>如果是 pollTimeout 则 Reset the generation and memberId because we have fallen out of the group，此时 consumer 会退出 group，当再次 poll 时又会 rejoin group 触发 rebalance group。</p>
<h4 id="Rebalance_Generation">Rebalance Generation</h4>
<p>表示 rebalance 之后的一届成员，主要是用于保护 consumer group，隔离无效 offset 提交。每次 group 进行 rebalance 之后，generation 号都会加 1，表示 group 进入到了一个新的版本，下图所示为 consumer 2 退出后 consumer 4 加入时 Rebalance Generation 的过程：<br><img src="/img/Kafka_Rebalance_Generation.png" alt="Rebalance Generation"></p>
<h2 id="partition_的数量设置">partition 的数量设置</h2>
<ul>
<li><p>一个 partition 只能被 Consumer Group 中的一个 consumer 消费，因此，为了提高并发量，可以提高 partition 的数量，但是这会造成 replica 副本拷贝的网络请求增加，故障恢复时的耗时增加。因为 kafka 使用 batch pull 的方式，所以单个线程的消费速率还是有保障的。并且 partition 数量过多，zk 维护 ISR 列表负载较重。</p>
</li>
<li><p>partiton 数量最好是 consumer 数目的整数倍，比如取 24， consumer 数目的设置就会灵活很多。</p>
</li>
<li><p>consumer 消费消息时不时严格有序的。当从多个 partition 读数据时，kafka 只保证在一个 partition 上数据是有序的，多个 partition 的消息消费很可能就不是严格有序的了。</p>
</li>
</ul>
<h2 id="参数设置">参数设置</h2>
<h3 id="heartbeat-interval-ms">heartbeat.interval.ms</h3>
<p>心跳间隔。心跳是在 consumer 与 coordinator 之间进行的。心跳是确定 consumer 存活，加入或者退出 group 的有效手段。<br>这个值必须设置的小于 session.timeout.ms，因为：<br>当 consumer 由于某种原因不能发 heartbeat 到 coordinator 时，并且时间超过 session.timeout.ms 时，就会认为该 consumer 已退出，它所订阅的 partition 会分配到同一 group 内的其它的 consumer 上。</p>
<h4 id="参数值">参数值</h4>
<p>默认值：3000 (3s)，通常设置的值要低于session.timeout.ms的1/3。</p>
<p></p><p></p>
<h3 id="session-timeout-ms">session.timeout.ms</h3>
<p>consumer session 过期时间。如果超时时间范围内，没有收到消费者的心跳，broker 会把这个消费者置为失效，并触发消费者负载均衡。因为只有在调用 poll 方法时才会发送心跳，更大的 session 超时时间允许消费者在 poll 循环周期内处理消息内容，尽管这会有花费更长时间检测失效的代价。如果想控制消费者处理消息的时间，</p>
<h4 id="参数值-1">参数值</h4>
<p>默认值：10000 (10s)，这个值必须设置在 broker configuration 中的 group.min.session.timeout.ms 与 group.max.session.timeout.ms 之间。</p>
<p>

<h3 id="max-poll-interval-ms">max.poll.interval.ms</h3>
</p><p>This config sets the maximum delay between client calls to poll(). </p>
<p>When the timeout expires, the consumer will stop sending heartbeats and send an explicit LeaveGroup request. </p>
<p>As soon as the consumer resumes processing with another call to poll(), the consumer will <strong>rejoin the group</strong>. </p>
<p>By increasing the interval between expected polls, you can give the consumer more time to handle a batch of records returned frompoll(long). The drawback is that increasing this value may delay a group rebalance since the consumer will only join the rebalance inside the call to poll. You can use this setting to bound the time to finish a rebalance, but you risk slower progress if the consumer cannot actually call poll often enough.</p>
<p>参数设置大一点可以增加两次 poll 之间处理消息的时间。<br>当 consumer 一切正常(也就是保持着 heartbeat )，且参数的值小于消息处理的时长，会导致 consumer leave group 然后又 rejoin group，触发无谓的 group balance，出现 consumer livelock 现象。</p>
<p>但如果设置的太大，会延迟 group rebalance，因为消费者只会在调用 poll 时加入rebalance。</p>
<p>

<h3 id="max-poll-records">max.poll.records</h3>
</p><p>Use this setting to limit the total records returned from a single call to poll. This can make it easier to predict the maximum that must be handled within each poll interval. By tuning this value, you may be able to reduce the poll interval, which will reduce the impact of group rebalancing.</p>
<p>0.11.0 Kafka 的默认配置是 </p>
<ul>
<li>max.poll.interval.ms=5min</li>
<li>max.poll.records=500</li>
</ul>
<p>即平均 600ms 要处理完一条消息，如果消息的消费时间高于 600ms，则一定要调整 max.poll.records 或 max.poll.interval.ms。</p>
<h2 id="Kafka_Javadoc_-_Detecting_Consumer_Failures">Kafka Javadoc - Detecting Consumer Failures</h2>
<p>After subscribing to a set of topics, the consumer will automatically join the group when poll(long) is invoked. The poll API is designed to ensure consumer liveness. As long as you continue to call poll, the consumer will stay in the group and continue to receive messages from the partitions it was assigned. Underneath the covers, the consumer sends periodic heartbeats to the server. If the consumer crashes or is unable to send heartbeats for a duration of session.timeout.ms, then the consumer will be considered dead and its partitions will be reassigned.<br>It is also possible that the consumer could encounter a “livelock” situation where it is continuing to send heartbeats, but no progress is being made. To prevent the consumer from holding onto its partitions indefinitely in this case, we provide a liveness detection mechanism using the max.poll.interval.ms setting. Basically if you don’t call poll at least as frequently as the configured max interval, then the client will proactively leave the group so that another consumer can take over its partitions. When this happens, you may see an offset commit failure (as indicated by a CommitFailedException thrown from a call to commitSync()). This is a safety mechanism which guarantees that only active members of the group are able to commit offsets. So to stay in the group, you must continue to call poll. </p>
<h2 id="Reference">Reference</h2>
<p><a href="http://www.cnblogs.com/huxi2b/p/6223228.html" target="_blank" rel="external">Kafka消费组(consumer group)</a><br><a href="https://kafka.apache.org/0101/javadoc/index.html?org/apache/kafka/clients/consumer/KafkaConsumer.html" target="_blank" rel="external">kafka.apache.org javadoc</a><br><a href="http://blog.leanote.com/post/zfb050/Coordinator%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" target="_blank" rel="external">Coordinator实现原理</a><br><a href="http://debugo.com/kafka-params/" target="_blank" rel="external">kafka params</a><br><a href="http://blog.csdn.net/u014393917/article/details/52043185" target="_blank" rel="external">kafka源码分析之kafka的consumer的负载均衡管理</a><br><a href="http://www.cnblogs.com/devos/p/5656232.html" target="_blank" rel="external">Group Management Protocol</a><br><a href="http://matt33.com/2017/01/16/kafka-group/" target="_blank" rel="external">Kafka 之 Group 状态变化分析及 Rebalance 过程</a><br><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-62%3A+Allow+consumer+to+send+heartbeats+from+a+background+thread" target="_blank" rel="external">KIP-62: Allow consumer to send heartbeats from a background thread</a><br><a href="https://www.safaribooksonline.com/library/view/kafka-the-definitive/9781491936153/ch04.html" target="_blank" rel="external">Kafka: The Definitive Guide Chapter 4 - Kafka Consumers</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/分布式/">分布式</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://luojinping.com/2017/11/12/Kafka-Consumer-的实现/" data-title="Kafka Consumer 的实现 | Zane Blog" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/01/31/LeetCode-Trapping-Rain-Water/" title="LeetCode-Trapping-Rain-Water">
  <strong>上一篇：</strong><br/>
  <span>
  LeetCode-Trapping-Rain-Water</span>
</a>
</div>


<div class="next">
<a href="/2017/11/12/解决-Kafka-Consumer-卡顿的问题/"  title="解决 Kafka Consumer 卡顿的问题">
 <strong>下一篇：</strong><br/> 
 <span>解决 Kafka Consumer 卡顿的问题
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer_拉取消息的实现"><span class="toc-number">1.</span> <span class="toc-text">Consumer 拉取消息的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Consumer_拉取消息的数量"><span class="toc-number">1.1.</span> <span class="toc-text">Consumer 拉取消息的数量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#poll_和_fetch_的关系"><span class="toc-number">1.1.1.</span> <span class="toc-text">poll 和 fetch 的关系</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer_的心跳机制"><span class="toc-number">2.</span> <span class="toc-text">Consumer 的心跳机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sessionTimeout"><span class="toc-number">2.1.</span> <span class="toc-text">sessionTimeout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pollTimeout"><span class="toc-number">2.2.</span> <span class="toc-text">pollTimeout</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Rebalance_Generation"><span class="toc-number">2.2.1.</span> <span class="toc-text">Rebalance Generation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#partition_的数量设置"><span class="toc-number">3.</span> <span class="toc-text">partition 的数量设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参数设置"><span class="toc-number">4.</span> <span class="toc-text">参数设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#heartbeat-interval-ms"><span class="toc-number">4.1.</span> <span class="toc-text">heartbeat.interval.ms</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参数值"><span class="toc-number">4.1.1.</span> <span class="toc-text">参数值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session-timeout-ms"><span class="toc-number">4.2.</span> <span class="toc-text">session.timeout.ms</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参数值-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">参数值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#max-poll-interval-ms"><span class="toc-number">4.3.</span> <span class="toc-text">max.poll.interval.ms</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#max-poll-records"><span class="toc-number">4.4.</span> <span class="toc-text">max.poll.records</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka_Javadoc_-_Detecting_Consumer_Failures"><span class="toc-number">5.</span> <span class="toc-text">Kafka Javadoc - Detecting Consumer Failures</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">6.</span> <span class="toc-text">Reference</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/java/" title="java">java<sup>15</sup></a></li>
		
			<li><a href="/tags/机器学习/" title="机器学习">机器学习<sup>13</sup></a></li>
		
			<li><a href="/tags/算法/" title="算法">算法<sup>10</sup></a></li>
		
			<li><a href="/tags/多线程/" title="多线程">多线程<sup>6</sup></a></li>
		
			<li><a href="/tags/LeetCode/" title="LeetCode">LeetCode<sup>4</sup></a></li>
		
			<li><a href="/tags/机器学习实战/" title="机器学习实战">机器学习实战<sup>3</sup></a></li>
		
			<li><a href="/tags/数学/" title="数学">数学<sup>3</sup></a></li>
		
			<li><a href="/tags/调试/" title="调试">调试<sup>3</sup></a></li>
		
			<li><a href="/tags/分布式/" title="分布式">分布式<sup>3</sup></a></li>
		
			<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
		
			<li><a href="/tags/网络/" title="网络">网络<sup>2</sup></a></li>
		
			<li><a href="/tags/安全/" title="安全">安全<sup>1</sup></a></li>
		
			<li><a href="/tags/spark/" title="spark">spark<sup>1</sup></a></li>
		
			<li><a href="/tags/Spark/" title="Spark">Spark<sup>1</sup></a></li>
		
			<li><a href="/tags/Spring/" title="Spring">Spring<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>1</sup></a></li>
		
			<li><a href="/tags/skill/" title="skill">skill<sup>1</sup></a></li>
		
			<li><a href="/tags/promote/" title="promote">promote<sup>1</sup></a></li>
		
			<li><a href="/tags/总结/" title="总结">总结<sup>1</sup></a></li>
		
			<li><a href="/tags/并发/" title="并发">并发<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m ljp215 Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Pacman">Jacman</a> © 2019 
		
		<a href="http://luojinping.com/about" target="_blank" title="Jinping Luo">Jinping Luo</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>




<script type="text/javascript">

var disqus_shortname = 'zane215';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fnull' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<!-- MathJax End -->

  </body>
</html>
