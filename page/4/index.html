
 <!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>Zane Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Jinping Luo">
    
    
    <meta property="og:type" content="website">
<meta property="og:title" content="Zane Blog">
<meta property="og:url" content="http://luojinping.com/page/4/index.html">
<meta property="og:site_name" content="Zane Blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zane Blog">

    
    <link rel="alternative" href="/atom.xml" title="Zane Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a2d87d3add52ff134d9fac6cc16e4800";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
</html>
  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Zane Blog" title="Zane Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Zane Blog">Zane Blog</a></h1>
				<h2 class="blog-motto">业精于勤荒于嬉，形成思毁于随</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:luojinping.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/22/初学Spark/" title="初学Spark" itemprop="url">初学Spark</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-01-22T03:41:20.000Z" itemprop="datePublished"> Published Jan 22 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="避免使用-GroupByKey"><a href="#避免使用-GroupByKey" class="headerlink" title="避免使用 GroupByKey"></a>避免使用 GroupByKey</h1><p>当调用 groupByKey 时，所有的键值对(key-value pair) 都会被移动。在网络上传输这些数据非常没有必要。</p>
<p>以下函数应该优先于 groupByKey :</p>
<ul>
<li><p>combineByKey<br>组合数据，但是组合之后的数据类型与输入时值的类型不一样。</p>
</li>
<li><p>foldByKey<br>合并每一个 key 的所有值，在级联函数和“零值”中使用。</p>
</li>
</ul>
<p>#combineByKey</p>
<h2 id="combineByKey的定义"><a href="#combineByKey的定义" class="headerlink" title="combineByKey的定义"></a>combineByKey的定义</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def combineByKey[C](</span><br><span class="line">  createCombiner: V =&gt; C,</span><br><span class="line">  mergeValue: (C, V) =&gt; C, </span><br><span class="line">  mergeCombiners: (C, C) =&gt; C, </span><br><span class="line">  partitioner: Partitioner, </span><br><span class="line">  mapSideCombine: Boolean = true, </span><br><span class="line">  serializer: Serializer = null): RDD[(K, C)] = &#123;</span><br><span class="line">  // do something</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>combineByKey函数主要接受了三个函数作为参数，分别为createCombiner、mergeValue、mergeCombiners。这三个函数足以说明它究竟做了什么。理解了这三个函数，就可以很好地理解combineByKey。</p>
<h3 id="createCombiner"><a href="#createCombiner" class="headerlink" title="createCombiner"></a>createCombiner</h3><p>createCombiner：在遍历RDD的过程中，对于遍历到的(k,v)，如果是第一次遇到，则对这个(k,v)调用createCombiner函数，它的作用是将v转换为c(类型是C，即聚合对象的类型，c作为聚合对象的初始值)</p>
<h3 id="mergeValue"><a href="#mergeValue" class="headerlink" title="mergeValue"></a>mergeValue</h3><p>mergeValue：在遍历RDD的过程中，对于遍历到的(k,v)，如果不是第一次(而是第i次, 1 &lt; i &lt;= n)遇到，那么将对这个(k,v)调用mergeValue函数，它的作用是将v累加到聚合对象（类型C）中，mergeValue的类型是(C,V)=&gt;C,参数中的C遍历到此处的聚合对象，然后对v进行聚合得到新的聚合对象值</p>
<h3 id="mergeCombiners"><a href="#mergeCombiners" class="headerlink" title="mergeCombiners"></a>mergeCombiners</h3><p>mergeCombiners：<strong>因为combineByKey是在分布式环境下执行，RDD的每个分区单独进行combineByKey操作，最后需要对各个分区的结果进行最后的聚合</strong>。它的函数类型是(C,C)=&gt;C，每个参数是分区聚合得到的聚合对象。</p>
<h3 id="combineByKey的流程"><a href="#combineByKey的流程" class="headerlink" title="combineByKey的流程"></a>combineByKey的流程</h3><ul>
<li>假设一组具有相同 K 的 &lt;K, V&gt; records 正在一个个流向 combineByKey()，createCombiner 将第一个 record 的value 初始化为 c （比如，c = value），然后从第二个 record 开始，来一个 record 就使用 mergeValue(c,</li>
<li>record.value) 来更新 c，比如想要对这些 records 的所有 values 做 sum，那么使用 c = c + record.value。等到records 全部被 mergeValue()，得到结果 c。假设还有一组 records（key 与前面那组的 key 均相同）一个个到来，</li>
<li>combineByKey() 使用前面的方法不断计算得到 c’。现在如果要求这两组 records 总的 combineByKey() 后的结果，那么可以使用 final c = mergeCombiners(c, c’) 来计算。</li>
</ul>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var rdd1 = sc.makeRDD(Array((&quot;A&quot;,1),(&quot;A&quot;,2),(&quot;A&quot;,3),(&quot;B&quot;,1),(&quot;B&quot;,2),(&quot;C&quot;,3)))</span><br><span class="line"></span><br><span class="line">// result: ((A,1_$2_@3), (B,1_$2_), (C,3_))</span><br><span class="line">rdd1.combineByKey(</span><br><span class="line">  (v : Int) =&gt; v + &quot;_&quot;,</span><br><span class="line">  (c : String, v : Int) =&gt; c + &quot;@&quot; + v,</span><br><span class="line">  (c1 : String, c2 : String) =&gt; c1 + &quot;$&quot; + c2 ).collect</span><br></pre></td></tr></table></figure>

<h2 id="combineByKey应用举例"><a href="#combineByKey应用举例" class="headerlink" title="combineByKey应用举例"></a>combineByKey应用举例</h2><h3 id="求均值"><a href="#求均值" class="headerlink" title="求均值"></a>求均值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">val rdd = sc.textFile(&quot;气象数据&quot;)</span><br><span class="line">val rdd2 = rdd.map(x=&gt;x.split(&quot; &quot;)).map(x =&gt; (x(0).substring(&quot;从年月日中提取年月&quot;),x(1).toInt))</span><br><span class="line">val createCombiner = (k: String, v: Int)=&gt; &#123;</span><br><span class="line">  (v,1)</span><br><span class="line">&#125;</span><br><span class="line">val mergeValue = (c:(Int, Int), v:Int) =&gt; &#123;</span><br><span class="line">  (c._1 + v, c._2 + 1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">val mergeCombiners = (c1:(Int,Int),c2:(Int,Int))=&gt;&#123;</span><br><span class="line">  (c1._1 + c2._1, c1._2 + c2._2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">val vdd3 = vdd2.combineByKey(</span><br><span class="line">  createCombiner,</span><br><span class="line">  mergeValue,</span><br><span class="line">  mergeCombiners</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">rdd3.foreach(x=&gt;println(x._1 + &quot;: average tempreture is &quot; + x._2._1/x._2._2)</span><br></pre></td></tr></table></figure>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/spark/">spark</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/22/初学Spark/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/04/Run-Age-of-Empires-II-in-Max-OS-10-11/" title="Run Age of Empires II in Max OS 10.11" itemprop="url">Run Age of Empires II in Max OS 10.11</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-01-04T12:52:39.000Z" itemprop="datePublished"> Published Jan 4 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="Step1-Find-the-resource"><a href="#Step1-Find-the-resource" class="headerlink" title="Step1 Find the resource"></a>Step1 Find the resource</h2><p>search in Google， steam 上已经没有了。</p>
<h2 id="Step2-Fix-the-Max-OS-10-11-bug"><a href="#Step2-Fix-the-Max-OS-10-11-bug" class="headerlink" title="Step2 Fix the Max OS 10.11 bug"></a>Step2 Fix the Max OS 10.11 bug</h2><p>An error occured while starting the X11 server:<br>    Failed to activate core devices”<br>    Click Quit to quit X11. Click Report to see more details or send a report to Apple. </p>
<p>在 <a href="https://www.reddit.com/r/OSXElCapitan/comments/3d64sd/wineskin/" target="_blank" rel="noopener">https://www.reddit.com/r/OSXElCapitan/comments/3d64sd/wineskin/</a> 找到解决方法。即:<br>open terminal: </p>
<p><code>mkdir</code>/lib<br><code>cp -r /Applications/aoeHD.app/Contents/Frameworks/</code>* /lib </p>
<p>此时再打开游戏，成功运行，听到了熟悉的声音。</p>
<p>Reference<br><a href="https://www.reddit.com/r/OSXElCapitan/comments/3d64sd/wineskin/" target="_blank" rel="noopener">https://www.reddit.com/r/OSXElCapitan/comments/3d64sd/wineskin/</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/skill/">skill</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/04/Run-Age-of-Empires-II-in-Max-OS-10-11/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/03/skills/" title="skills" itemprop="url">skills</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-01-03T04:28:17.000Z" itemprop="datePublished"> Published Jan 3 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="将数据转成json格式：python-m-json-tool"><a href="#将数据转成json格式：python-m-json-tool" class="headerlink" title="将数据转成json格式：python -m json.tool"></a>将数据转成json格式：python -m json.tool</h3><pre><code>$ echo &apos;{&quot;json&quot;:&quot;obj&quot;}&apos; | python -m json.tool
{
&quot;json&quot;: &quot;obj&quot;
}</code></pre><h3 id="查看gzip数据"><a href="#查看gzip数据" class="headerlink" title="查看gzip数据"></a>查看gzip数据</h3><p>使用python的zlib库来解压</p>
<pre><code>s=&apos;\x1F\x8B\x08\x00\x00\x00\x00\x00\x00\x005N\xCD\x0A\xC3 \x18{\x97\xEF,\xE5s\xF3gz\xAB\xA0/1z\x18\xC31\x87m\xA5\xEA\xA1\x94\xBE\xFB\xBE\xC3vJHB\x92\x03z\x8D\xDBXJ\x05{?\xA0,`\xE1\xB9\xCEC\xEB\x9F\xF4\x18\xDEk\x8B\x19\x18\xD4\x99d\xC9/\xCE\xF9\x10Ft\xE1\xAA\x9DFm\x8C\x92B)w\xF3\x02\xBD\xA1\x5C\xA3\x16.\x84\xE4\x5CHD\x94\x82Ao`\x97\x9E3\x83Df\xDBzdP\xD2_{\x11C\x06\xB9\x13\x9C\x13\x0D\xED\xF5\xF7e:\xBF\xAB \xDB\x10\x9B\x00\x00\x00&apos; 

import zlib
d=zlib.decompressobj(16+zlib.MAX_WBITS) 
data=d.decompress(s)</code></pre><h3 id="统计服务器上的历史登录记录"><a href="#统计服务器上的历史登录记录" class="headerlink" title="统计服务器上的历史登录记录"></a>统计服务器上的历史登录记录</h3><pre><code>last -ad | awk &apos;{print $1}&apos; | sort | uniq -c | sort -t$&apos;\t&apos; -k1,1 -nr </code></pre><h3 id="linux文件格式转换"><a href="#linux文件格式转换" class="headerlink" title="linux文件格式转换"></a>linux文件格式转换</h3><p>在linux下，不可避免的会用VIM打开一些windows下编辑过的文本文件。我们会发现文件的每行结尾都会有一个^M符号，这是因为DOS下的编辑器和Linux编辑器对文件行末的回车符处理不一致，<br>对于回车符的定义： </p>
<ul>
<li>windows：0D0A </li>
<li>unix\linux: 0A </li>
<li>MAC: 0D<br>去除这些符号的方法有： </li>
<li>vim下 <code>:set fileformat=unix</code></li>
<li>终端  <code>dos2unix filename</code></li>
</ul>
<h3 id="git图形化提交历史"><a href="#git图形化提交历史" class="headerlink" title="git图形化提交历史"></a>git图形化提交历史</h3><pre><code>git log --pretty=format:&quot;%h %an %s&quot; --graph</code></pre><h3 id="echo-总结"><a href="#echo-总结" class="headerlink" title="echo 总结"></a>echo 总结</h3><ol>
<li>echo默认是带换行符做结尾的</li>
<li>echo -n 可以去掉换行符</li>
<li>printf是没有换行符结尾的</li>
<li>tr可以删掉一个字符，如 tr -d ‘\n’ </li>
</ol>
<h3 id="删除空行"><a href="#删除空行" class="headerlink" title="删除空行"></a>删除空行</h3><ol>
<li>grep: grep -v ‘^$’ file</li>
<li>sed: sed ‘/^$/d’  file 或 sed -n ‘/./p’ file</li>
<li>awk: awk ‘/./ {print}’ file</li>
</ol>
<h3 id="shell读文件"><a href="#shell读文件" class="headerlink" title="shell读文件"></a>shell读文件</h3><p>读取 md5s 文件，对每行做处理。</p>
<pre><code>cat md5s | while read line 
do 
     md5=$line 
     level2Path=`expr substr &quot;$md5&quot; 30 2` #50 
     level1Path=`expr substr &quot;$md5&quot; 32 1` #a 
     storagePath=hdfs:///ljp/apk/path/$level1Path/$level2Path/$md5 
     echo $storagePath
done </code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/调试/">调试</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/03/skills/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/03/Java序列化/" title="Java序列化" itemprop="url">Java序列化</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-01-03T01:49:17.000Z" itemprop="datePublished"> Published Jan 3 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="什么是序列化"><a href="#什么是序列化" class="headerlink" title="什么是序列化"></a>什么是序列化</h2><p>java 序列化是将对象转化为二进制流。不同的序列化框架会将对象转成不同的二进制流。通过 <a href="http://www.solinx.co/archives/377" target="_blank" rel="noopener">透过byte数组简单分析Java序列化、Kryo、ProtoBuf序列化</a> 这篇文章里可以看到，不同的序列化框架最终转成的二进制流是不一样的。</p>
<h2 id="Java-默认序列化"><a href="#Java-默认序列化" class="headerlink" title="Java 默认序列化"></a>Java 默认序列化</h2><h3 id="默认序列化机制"><a href="#默认序列化机制" class="headerlink" title="默认序列化机制"></a>默认序列化机制</h3><p>如果仅仅只是让某个类实现Serializable接口，而没有其它任何处理的话，则就是使用默认序列化机制。使用默认机制，在序列化对象时，不仅会序列化当前对象本身，还会对该对象引用的其它对象也进行序列化，同样地，这些其它对象引用的另外对象也将被序列化，以此类推。所以，如果一个对象包含的成员变量是容器类对象，而这些容器所含有的元素也是容器类对象，那么这个序列化的过程就会较复杂，开销也较大。</p>
<p>整个过程都是Java虚拟机（JVM）独立的，也就是说，在一个平台上序列化的对象可以在另一个完全不同的平台上反序列化该对象。</p>
<h3 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h3><p>serialVersionUID的作用<br>不仅取决于类路径和功能代码是否一致，一个非常重要的一点是两个类的序列化 ID 是否一致（就是 <code>private static final long serialVersionUID = 1L</code>）</p>
<h3 id="Java-序列化实现"><a href="#Java-序列化实现" class="headerlink" title="Java 序列化实现"></a>Java 序列化实现</h3><h4 id="ObjectInputStream-amp-amp-ObjectOutputStream"><a href="#ObjectInputStream-amp-amp-ObjectOutputStream" class="headerlink" title="ObjectInputStream &amp;&amp; ObjectOutputStream"></a>ObjectInputStream &amp;&amp; ObjectOutputStream</h4><p>类ObjectInputStream 和ObjectOutputStream是高层次的数据流，它们包含序列化和反序列化对象的方法。<br>ObjectOutputStream 类包含很多写方法来写各种数据类型，但是一个特别的方法例外：</p>
<pre><code>public final void writeObject(Object x) throws IOException</code></pre><p>上面的方法序列化一个对象，并将它发送到输出流。相似的ObjectInputStream 类包含如下反序列化一个对象的方法：</p>
<pre><code>public final Object readObject() throws IOException, ClassNotFoundException</code></pre><p>该方法从流中取出下一个对象，并将对象反序列化。它的返回值为Object，因此，你需要将它转换成合适的数据类型。</p>
<h4 id="Serializable-接口"><a href="#Serializable-接口" class="headerlink" title="Serializable 接口"></a>Serializable 接口</h4><p>情境：一个子类实现了 Serializable 接口，它的父类都没有实现 Serializable 接口，序列化该子类对象，然后反序列化后输出父类定义的某变量的数值，该变量数值与序列化时的数值不同。<br>解决：要想将父类对象也序列化，就需要让父类也实现Serializable 接口。如果父类不实现的话的，就 需要有默认的无参的构造函数。在父类没有实现 Serializable 接口时，虚拟机是不会序列化父对象的，而一个 Java 对象的构造必须先有父对象，才有子对象，反序列化也不例外。所以反序列化时，为了构造父对象，只能调用父类的无参构造函数作为默认的父对象。因此当我们取父对象的变量值时，它的值是调用父类无参构造函数后的值。如果你考虑到这种序列化的情况，在父类无参构造函数中对变量进行初始化，否则的话，父类变量值都是默认声明的值，如 int 型的默认是 0，string 型的默认是 null。</p>
<h4 id="Externalizable-接口"><a href="#Externalizable-接口" class="headerlink" title="Externalizable 接口"></a>Externalizable 接口</h4><p>无论是使用transient关键字，还是使用writeObject()和readObject()方法，其实都是基于Serializable接口的序列化。JDK中提供了另一个序列化接口—Externalizable，使用该接口之后，之前基于Serializable接口的序列化机制就将失效。<br>writeExternal：把一个Java对象写入到流中<br>readExternal：从流中读取一个Java对象</p>
<h2 id="java序列化一览"><a href="#java序列化一览" class="headerlink" title="java序列化一览"></a>java序列化一览</h2><p><img src="img/java_serialize_%20summary.png" alt></p>
<h2 id="Java-序列化框架比较"><a href="#Java-序列化框架比较" class="headerlink" title="Java 序列化框架比较"></a>Java 序列化框架比较</h2><h3 id="性能比较"><a href="#性能比较" class="headerlink" title="性能比较"></a>性能比较</h3><p><img src="img/serialize_performance_compare.png" alt></p>
<h3 id="测试方法"><a href="#测试方法" class="headerlink" title="测试方法"></a>测试方法</h3><p><a href="https://github.com/eishay/jvm-serializers" target="_blank" rel="noopener">jvm-serializers</a> 提供了一个很好的比较各种Java序列化的的测试套件。 它罗列了各种序列化框架， 可以自动生成测试报告。</p>
<h3 id="适用性比较"><a href="#适用性比较" class="headerlink" title="适用性比较"></a>适用性比较</h3><ul>
<li>json<br>json的序列化框架有fastjson,jackson,gson等。<br>适用于数据量小，实时性较低（例如秒级别）的服务。JSON格式具有非常强的前后兼容性，并且调式方便，所以对客户端与服务端的通讯尤其适用。</li>
<li>xml<br>xml的序列化框架有XStream。XML的序列化和反序列化的空间和时间开销都比较大，对于对性能要求在ms级别的服务，不推荐使用。</li>
<li>hessian<br>hessian主要用于java序列化。它的实现机制是着重于数据，附带简单的类型信息的方法：</li>
<li>对于简单的数据类型。就像Integer a = 1，hessian会序列化成I 1这样的流，I表示int or Integer，1就是数据内容。<ul>
<li>对于复杂对象，通过Java的反射机制，hessian把对象所有的属性当成一个Map来序列化，产生类似M className propertyName1 I 1 propertyName S stringValue</li>
<li>对于引用对象，在序列化过程中，如果一个对象之前出现过，hessian会直接插入一个R index这样的块来表示一个引用位置，从而省去再次序列化和反序列化的时间。</li>
</ul>
</li>
<li>thift<br>Thrift是Facebook开源提供的一个高性能，轻量级RPC服务框架，其产生正是为了满足当前大数据量、分布式、跨语言、跨平台数据通讯的需求。 但是，Thrift并不仅仅是序列化协议，而是一个RPC框架。相对于JSON和XML而言，Thrift在空间开销和解析性能上有了比较大的提升，对于对性能要求比较高的分布式系统，它是一个优秀的RPC解决方案；但是由于Thrift的序列化被嵌入到Thrift框架里面，Thrift框架本身并没有透出序列化和反序列化接口，这导致其很难和其他传输层协议共同使用（例如HTTP）。</li>
<li>protobuf<br>  序列化数据非常简洁，紧凑，析速度非常快，提供了非常友好的动态库。使用简介，反序列化只需要一行代码。但是在JavaBean和proto之间的转换较麻烦。</li>
<li>avro<br>Avro的产生解决了JSON的冗长和没有IDL的问题。 Avro提供两种序列化格式：JSON格式或者Binary格式。Binary格式在空间开销和解析性能方面可以和Protobuf媲美，JSON格式方便测试阶段的调试。</li>
<li>动态类型：Avro并不需要生成代码，模式和数据存放在一起，而模式使得整个数据的处理过程并不生成代码、静态数据类型等等。这方便了数据处理系统和语言的构造。<ul>
<li>未标记的数据：由于读取数据的时候模式是已知的，那么需要和数据一起编码的类型信息就很少了，这样序列化的规模也就小了。</li>
<li>不需要用户指定字段号：即使模式改变，处理数据时新旧模式都是已知的，所以通过使用字段名称可以解决差异问题。</li>
</ul>
</li>
</ul>
<p>Reference</p>
<blockquote>
<p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-serial/" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/java/j-lo-serial/</a><br><a href="http://www.infoq.com/cn/articles/serialization-and-deserialization" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/serialization-and-deserialization</a><br><a href="http://sqtds.github.io/2015/05/13/2015/java-serizable/" target="_blank" rel="noopener">http://sqtds.github.io/2015/05/13/2015/java-serizable/</a><br><a href="http://www.solinx.co/archives/377" target="_blank" rel="noopener">http://www.solinx.co/archives/377</a></p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/java/">java</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/01/03/Java序列化/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/13/本地连机房Spark的调试过程/" title="本地连机房Spark的调试过程" itemprop="url">本地连机房Spark的调试过程</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2015-11-13T13:19:27.000Z" itemprop="datePublished"> Published Nov 13 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>##调试过程</p>
<p>本地运行代码，输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">15/11/12 12:09:51 INFO SparkContext: Running Spark version 1.5.1</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: scala/collection/GenTraversableOnce$class</span><br><span class="line">    at org.apache.spark.util.TimeStampedWeakValueHashMap.&lt;init&gt;(TimeStampedWeakValueHashMap.scala:42)</span><br><span class="line">    at org.apache.spark.SparkContext.&lt;init&gt;(SparkContext.scala:287)</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: scala.collection.GenTraversableOnce$class</span><br></pre></td></tr></table></figure>

<p>查了半天没有任何结果，大家分析的原因各式各样。后来看到了一位仁兄总结的帖子：<a href="http://zhangyi.farbox.com/post/wen-ti-jie-jue/solve-spark-issue-of-all-masters-are-unresponsive" target="_blank" rel="noopener">solve spark issue of all masters are unresponsive</a>，跑去spark机器看了一下log，果然有收获。</p>
<p>spark日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ReliableDeliverySupervisor: Association with remote system [akka.tcp://sparkDriver@100.64.80.93:57108] has failed, address is now gated for [5000] ms. Reason is: [scala.Option; local class incompatible: stream classdesc serialVersionUID = -114498752079829388, local class serialVersionUID = -2062608324514658839].</span><br></pre></td></tr></table></figure>

<p>根据 scala.Option; local class incompatible 可以发现是 scala 的版本不对，spark 默认的是 scala-2.10，需要改变依赖的scala版本。</p>
<p>改完以后又发现，还是连接不上。本地的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">15/11/12 21:46:22 ERROR SparkUncaughtExceptionHandler: Uncaught exception in thread Thread[appclient-registration-retry-thread,5,main]</span><br><span class="line">java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.FutureTask@5430d0ff rejected from java.util.concurrent.ThreadPoolExecutor@7819693b[Running, pool size = 1, active threads = 0, queued tasks = 0, completed tasks = 1]</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2047)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:823)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1369)</span><br><span class="line">    at java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:112)</span><br></pre></td></tr></table></figure>

<p>spark的日志如下：</p>
<p>A</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">15/11/12 21:46:03 ERROR ErrorMonitor: dropping message [class akka.actor.ActorSelectionMessage] for non-local recipient [Actor[akka.tcp://sparkMaster@10.19.27.215:4041/]] arriving at [akka.tcp://sparkMaster@10.19.27.215:4041] inbound addresses are [akka.tcp://sparkMaster@master1:4041]</span><br></pre></td></tr></table></figure>

<p>B</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">15/11/12 22:00:41 WARN ReliableDeliverySupervisor: Association with remote system [akka.tcp://sparkDriver@100.64.80.93:61812] has failed, address is now gated for [5000] ms. Reason is: [Disassociated].</span><br></pre></td></tr></table></figure>

<p>关于B这部分的log，怀疑是测试环境的spark的网络访问权限没有打开！最后打开网络访问权限后解决。spark master和worker之间的通信使用的是akka，tcp协议。</p>
<p>spark的A部分log和本地的log是一致的。</p>
<p>第二天接着查，查了很多地方。怀疑是Spark的配置不正确。<br>对于Spark的配置，官网说的是：</p>
<p>Options for the daemons used in the standalone deploy mode</p>
<p>SPARK_MASTER_IP, to bind the master to a different IP address or hostname</p>
<p>而我spark机器上的设置是：</p>
<ol>
<li>conf/spark-env.sh: export SPARK_MASTER_IP=master1</li>
<li>/etc/hosts: 10.x.xxx.215 master1</li>
</ol>
<p>一切配置正确但依然不行。Google上到处寻觅，找到 spark 的 group 里面的一个帖子，<a href="https://groups.google.com/forum/#!topic/spark-users/SKE4UOUQ_U8" target="_blank" rel="noopener">https://groups.google.com/forum/#!topic/spark-users/SKE4UOUQ_U8</a>，提到</p>
<blockquote>
<p>Yes, this message means that one of the workers tried to contact you using your IP address (10.129.7.154), but Akka is (somewhat stupidly) configured to rely on a DNS name (namely ip-10-129-7-154). If you’ve set up the Spark standalone mode, there was a bug in the scripts where they would use an IP address for the master instead of a hostname.</p>
</blockquote>
<p>所以当我将 SMART_IP 改成 ip 而不是 hostname 后，本地终于能连上spark了，设置如下：</p>
<p>conf/spark-env.sh: export SPARK_MASTER_IP=10.x.xxx.215</p>
<p>##几点备忘</p>
<ol>
<li><p>通过 %% 方法获取正确的 Scala 版本<br>如果你用是 groupID %% artifactID % revision 而不是 groupID % artifactID % revision（区别在于 groupID 后面是 %%），sbt 会在 工件名称中加上项目的 Scala 版本号。 这只是一种快捷方法。你可以这样写不用 %%：</p>
</li>
<li><p>enable build.sbt auto import<br>修改了 build.sbt，但是包没有引入生效</p>
</li>
<li><p>./spark-shell 加载配置文件<br>在Spark 集群上运行一个应用,只需通过master的 spark://IP:PORT 链接传递到SparkContext构造器<br>在集群上运行交互式的Spark 命令, 运行如下命令：<br>MASTER=spark://IP:PORT ./spark-shell<br>注意，如果你在一个 spark集群上运行了spark-shell脚本，spark-shell 将通过在conf/spark-env.sh下的SPARK_MASTER_IP和SPARK_MASTER_PORT自动设置MASTER</p>
</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Spark/">Spark</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/13/本地连机房Spark的调试过程/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/10/Mysql-Memo/" title="Mysql Memo" itemprop="url">Mysql Memo</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2015-11-10T15:08:03.000Z" itemprop="datePublished"> Published Nov 10 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>##1. contact</p>
<p>MySQL CONCAT function is used to concatenate two strings to form a single string.</p>
<p>MySQL GROUP_CONCAT() function returns a string with concatenated non-NULL value from a group.</p>
<p>数据库Person表的内容如下：</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">name</th>
<th align="center">source</th>
<th align="center">age</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">A</td>
<td align="center">GP</td>
<td align="center">6</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">B</td>
<td align="center">GP</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">A</td>
<td align="center">FB</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">C</td>
<td align="center">FB</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">D</td>
<td align="center">FB</td>
<td align="center">5</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">A</td>
<td align="center">FB</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">7</td>
<td align="center">C</td>
<td align="center">TW</td>
<td align="center">7</td>
</tr>
</tbody></table>
<br>

<p>1.SQL:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select name, count(distinct source) as sourceCount,</span><br><span class="line">group_concat(distinct source separator &quot;/&quot;) as sources</span><br><span class="line">from Person</span><br><span class="line">group by name;</span><br></pre></td></tr></table></figure>

<p>Query Result:</p>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">sourceCount</th>
<th align="center">sources</th>
</tr>
</thead>
<tbody><tr>
<td align="center">A</td>
<td align="center">2</td>
<td align="center">GP/FB</td>
</tr>
<tr>
<td align="center">B</td>
<td align="center">1</td>
<td align="center">GP</td>
</tr>
<tr>
<td align="center">C</td>
<td align="center">2</td>
<td align="center">GP/TW</td>
</tr>
<tr>
<td align="center">D</td>
<td align="center">1</td>
<td align="center">FB</td>
</tr>
</tbody></table>
<br>

<p>2.SQL:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select name, count(distinct source) as sourceCount,</span><br><span class="line">group_concat(distinct source separator &quot;/&quot;) as sources</span><br><span class="line">from Person</span><br><span class="line">group by name</span><br><span class="line">having sourceCount = 1 and sources = &apos;FB&apos;;</span><br></pre></td></tr></table></figure>

<p>Query Result:</p>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">sourceCount</th>
<th align="center">sources</th>
</tr>
</thead>
<tbody><tr>
<td align="center">D</td>
<td align="center">1</td>
<td align="center">FB</td>
</tr>
</tbody></table>
<br>

<p>3.SQL:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select name, count(distinct age) as ageCount,</span><br><span class="line">group_concat(age order by age separator &quot;#&quot;) as ages</span><br><span class="line">from Person;</span><br></pre></td></tr></table></figure>

<p>Query Result:</p>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">ageCount</th>
<th align="center">ages</th>
</tr>
</thead>
<tbody><tr>
<td align="center">A</td>
<td align="center">3</td>
<td align="center">1#3#6</td>
</tr>
<tr>
<td align="center">B</td>
<td align="center">1</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">C</td>
<td align="center">2</td>
<td align="center">4#7</td>
</tr>
<tr>
<td align="center">D</td>
<td align="center">1</td>
<td align="center">5</td>
</tr>
</tbody></table>
<p>##2. mysql -N 不显示字段名<br>普通的查询语句，查询结果中带字段名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> mysql -h xxxx -P 8000 -u&apos;xxx&apos; -p&apos;xxx&apos; -D xxdb</span><br><span class="line">-e &quot;select name from Person where name = &apos;A&apos;&quot;;</span><br></pre></td></tr></table></figure>

<p>+———–+</p>
<p>| name      |</p>
<p>+———–+</p>
<p>| not found |</p>
<p>+———–+</p>
<p>带-N的查询语句，查询结果中不带字段名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> mysql -N -h xxxx -P 8000 -u&apos;xxx&apos; -p&apos;xxx&apos; -D xxdb</span><br><span class="line">-e &quot;select name from Person where name = &apos;A&apos;&quot;;</span><br></pre></td></tr></table></figure>

<p>+———–+</p>
<p>| not found |</p>
<p>+———–+</p>
<p>##3. IFNULL<br>使用IFNULL能判断是否有查到结果。<br>在shell中跑mysql的指令容易出现空行，此时用IFNULL是最合适的了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> mysql -N -h xxxx -P 8000 -u&apos;xxx&apos; -p&apos;xxx&apos; -D xxdb</span><br><span class="line">-e &quot;select IFNULL(</span><br><span class="line">(select name from Person where name = &apos;A&apos; and age = 100),</span><br><span class="line">&apos;not found&apos;)&quot;</span><br></pre></td></tr></table></figure>

<p>+———–+</p>
<p>| not found |</p>
<p>+———–+</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/mysql/">mysql</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/10/Mysql-Memo/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/11/02/Java的内存泄露与垃圾回收/" title="Java的内存泄露与垃圾回收" itemprop="url">Java的内存泄露与垃圾回收</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2015-11-02T03:39:53.000Z" itemprop="datePublished"> Published Nov 2 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>##什么是内存泄露<br>内存泄露 memory leak，是指已申请的无用内存无法被回收。</p>
<p>内存泄漏有两种情况：</p>
<ul>
<li><p>一种情况如在C/C++语言中的，在堆中的分配的内存，在没有将其释放掉的时候，就将所有能访问这块内存的方式都删掉（如指针重新赋值)</p>
</li>
<li><p>** 一种情况则是在内存对象明明已经不需要的时候，还仍然保留着这块内存和它的访问方式（引用）**</p>
</li>
</ul>
<p>第一种情况，在Java中已经由于垃圾回收机制的引入，得到了很好的解决。所以，Java中的内存泄漏，主要指的是第二种情况。</p>
<p>内存泄露的一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for (int i = 0; i &lt; 1000; i++) &#123;</span><br><span class="line">      Object obj = new Object(</span><br><span class="line">      list.add(obj);</span><br><span class="line">      obj = null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码是：for循环中，new一个Object对象obj，然后将其添加到list中，最后将obj置空。</p>
<p>这个时候就发生了内存泄露，因为obj是可达的无用对象。发生GC时，尽管obj已经被置空成为了无用对象，但是obj能够从list可达，从而GC无法将其释放掉。次数obj占用的内存就是泄露了。</p>
<p>##内存泄露与内存溢出<br>内存溢出 out of memory，是指程序在申请内存时，没有足够的内存空间供其使用，出现out of memory。当发生内存溢出时，程序将无法进行，强制终止。在java中常见的java.lang.OutOfMemoryError就是内存溢出的log。</p>
<p><strong>内存长期泄露终将导致内存溢出。</strong></p>
<p>##内存泄露的危害<br>一次内存泄露危害可以忽略，但内存长期泄露，可用内存会逐渐减少，导致降低性能，最终内存溢出。</p>
<p>在移动设备对于内存和CPU都有较严格的限制的情况下，Java的内存泄露还会导致程序性能降低甚至崩溃。</p>
<p>##怎么产生内存泄露</p>
<p>容易引起内存泄漏的几大原因</p>
<ol>
<li><p>静态集合类</p>
<p> 像HashMap、Vector 等静态集合类的使用最容易引起内存泄漏，因为这些静态变量的生命周期与应用程序一致，如示例1，如果该Vector 是静态的，那么它将一直存在，而其中所有的Object对象也不能被释放，因为它们也将一直被该Vector 引用着。</p>
</li>
<li><p>监听器</p>
<p> 在java 编程中，我们都需要和监听器打交道，通常一个应用当中会用到很多监听器，我们会调用一个控件的诸如addXXXListener()等方法来增加监听器，但往往在释放对象的时候却没有记住去删除这些监听器，从而增加了内存泄漏的机会。</p>
</li>
<li><p>物理连接</p>
<p> 一些物理连接，比如数据库连接和网络连接，除非其显式的关闭了连接，否则是不会自动被GC 回收的。Java 数据库连接一般用DataSource.getConnection()来创建，当不再使用时必须用Close()方法来释放，因为这些连接是独立于JVM的。对于Resultset 和Statement 对象可以不进行显式回收，但Connection 一定要显式回收，因为Connection 在任何时候都无法自动回收，而Connection一旦回收，Resultset 和Statement 对象就会立即为NULL。但是如果使用连接池，情况就不一样了，除了要显式地关闭连接，还必须显式地关闭Resultset Statement 对象（关闭其中一个，另外一个也会关闭），否则就会造成大量的Statement 对象无法释放，从而引起内存泄漏。</p>
</li>
<li><p>内部类和外部模块等的引用</p>
<p> 内部类的引用是比较容易遗忘的一种，而且一旦没释放可能导致一系列的后继类对象没有释放。</p>
</li>
</ol>
<p>##垃圾回收</p>
<p><strong>可以手动执行垃圾回收吗？</strong></p>
<p>只能建议jvm进行GC，但什么时候做GC由JVM决定</p>
<p>###System.gc()<br>可以通过调用System.gc()建议JVM执行垃圾回收，但JVM不保证一定会执行GC操作。通常不推荐使用System.gc()。</p>
<p>###finalize()<br>finalize()方法存在于java.lang.Object类中，可以被所有对象所使用。默认情况下其不执行任何动作。当垃圾回收器确定了一个对象没有任何引用时，其会调用finalize()方法。但是，finalize方法并不一定会被执行，因此也不建议覆写finalize()该方法。</p>
<p>##内存泄露，会被垃圾回收吗<br>内存泄露 memory leak，是指已申请的无用内存无法被回收。GC只能回收第一种情况的内存泄露，见前面的释义。</p>
<p>##设置null能防止内存泄露吗<br>最基本的建议就是尽早释放无用对象的引用，大多数程序员在使用临时变量的时候，都是让引用变量在退出活动域后，自动设置为null。</p>
<p><strong>不过这个真的有用吗？</strong></p>
<p>查阅了网上的一些讨论以后有以下结论：</p>
<p>首先，jdk远比我们想象中的聪明，完全能判断出对象是否已经可以回收。但是在极少数情况下，这么做依然是有效的。</p>
<p><strong>这些情况是：方法前面中有定义大的对象,然后又跟着非常耗时的操作,且没有触发JIT编译。</strong></p>
<blockquote>
<p>JVM即时编译器：即时编译器（Just In Time Compiler) 简称JIT<br>     JAVA程序最初是通过解释器（Interpreter）进行解释执行的，当JVM发现某个方法或代码块运行特别频繁的时候，就会认为这是“热点代码”（Hot Spot Code)。<br>     为了提高热点代码的执行效率，就会将这些“热点代码”编译成与本地机器相关的机器码，进行各个层次的优化。 完成这个任务的编译器就是即时编译器（JIT）。</p>
</blockquote>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private void processObj() &#123;</span><br><span class="line">     BigObject obj = … // 声明大对象obj</span><br><span class="line">     doSomethingWith(obj); // 使用obj</span><br><span class="line">     obj = null;    // explicitly set to null</span><br><span class="line">     doSomethingElse(); //非常耗时的操作</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时显示的设置无用的对象obj为null才有效。</p>
<p>##How to avoid Memory Leak in Java</p>
<p>贴出 <a href="http://www.mindfiresolutions.com/How-to-avoid-Memory-leak-issue-in-Java-1001.php" target="_blank" rel="noopener"> How to avoid Memory leak issue in Java</a> 一文中提到的防止java内存泄露的一些建议。</p>
<p>How  to avoid Memory Leak in Java?</p>
<p>While coding if we take care of a few points we can avoid memory leak issue.</p>
<ol>
<li><p>Use time out time for the session as low as possible.</p>
</li>
<li><p>Release the session when the same is no longer required. We can release the session  by using HttpSession.invalidate().</p>
</li>
<li><p>Try to store as less data as possible in the HttpSession.</p>
</li>
<li><p>Avoid creating HttpSession in jsp page by default by using the page directive</p>
<p>  &lt;%@page session=”false”%&gt;</p>
</li>
<li><p>Try to use StringBuffer’s append() method instead of string concatenation. String is an immutable object and if we use string concatenation, it will unnecessarily create many temporary objects on heap which results in poor performance.</p>
<p> For ex. if we write String query =  “SELECT id, name FROM   t_customer whereMsoNormal” style=”margin-bottom: 0.0001pt;”&gt;     it will create 4 String Objects. But if we write the same query using StringBuffer’s append() it will create only one object as StringBuffer is mutable i.e. can be modified over and  over again.</p>
</li>
<li><p>In JDBC code, While writting the query try to avoid “*”. It is a good practice to use column name in select statement.</p>
</li>
<li><p>Try to use PreparedStatement object instead of Statement object if the query need to be executed frequently as PreparedStatement is a precompiled SQL statement where as Statement is compiled each time the Sql statement is sent to the database.</p>
</li>
<li><p>Try to close the ResultSet and Statement before reusing those.</p>
</li>
<li><p>If we use stmt = con.prepareStatement(sql query) inside loop, we should close it in the loop.</p>
</li>
<li><p>Try to close ResultSet, Statement, PreparedStatement and Connection in finally block.</p>
</li>
</ol>
<p>##在测试内存泄露时，对GC有一些收获</p>
<ol>
<li>cannot disable java gc</li>
<li>我们不能决定什么时候发生GC。</li>
<li>System.gc() vs GC button in JVisualVM/JConsole<br>As far as I know, Jconsole or any other tool, uses System.gc() only. There is no other option. As everyone know, java tells everyone not to rely on System.gc(), but that doesn’t mean it doesn’t work at all.</li>
</ol>
<p>##References</p>
<blockquote>
</blockquote>
<ul>
<li><a href="http://wwsun.me/posts/jvm-gc.html" target="_blank" rel="noopener">http://wwsun.me/posts/jvm-gc.html</a></li>
<li><a href="http://java.dzone.com/articles/jvm-and-garbage-collection" target="_blank" rel="noopener">http://java.dzone.com/articles/jvm-and-garbage-collection</a></li>
<li><a href="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html" target="_blank" rel="noopener">http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html</a></li>
<li><a href="http://chenjingbo.iteye.com/blog/1980908" target="_blank" rel="noopener">http://chenjingbo.iteye.com/blog/1980908</a></li>
<li><a href="http://www.mindfiresolutions.com/How-to-avoid-Memory-leak-issue-in-Java-1001.php" target="_blank" rel="noopener">http://www.mindfiresolutions.com/How-to-avoid-Memory-leak-issue-in-Java-1001.php</a></li>
<li><a href="http://www.infoq.com/cn/articles/cf-java-garbage-references" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/cf-java-garbage-references</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/java/">java</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/11/02/Java的内存泄露与垃圾回收/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/29/跨域请求/" title="跨域请求" itemprop="url">跨域请求</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2015-10-29T03:42:06.000Z" itemprop="datePublished"> Published Oct 29 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>##碰到的问题<br>今天做了一个feature的admin的接口api/xxv/abc/feature，便于ops在admin上直接管理配置信息。但是我们的域名是 ttt.company.com，所以admin应该访问<br><a href="http://ttt.company.com/api/xxv/abc/feature" target="_blank" rel="noopener">http://ttt.company.com/api/xxv/abc/feature</a><br>但是admin的域名是admin(-test).company.com，而且admin后台是需要登录的。这样就导致了前端跨域传cookie会有问题。</p>
<p>##解决的方案#</p>
<p>###1. nginx 做请求转发##<br>目前的做法是在服务端之前做一个反向代理，admin请求同域名的<br><a href="http://admin-test.company.com/api/abc/feature" target="_blank" rel="noopener">http://admin-test.company.com/api/abc/feature</a><br>然后在nginx层将请求转发到<br><a href="http://ttt.company.com/api/xxv/abc/feature" target="_blank" rel="noopener">http://ttt.company.com/api/xxv/abc/feature</a></p>
<p>对于staging和online不同的环境，将请求转发到不同的server即可。</p>
<p><strong><em>请求转发</em></strong><br><a href="http://admin-test.company.com/api/abc/feature" target="_blank" rel="noopener">http://admin-test.company.com/api/abc/feature</a><br>-&gt;<br><a href="http://ttt.company.com/api/xxv/abc/feature" target="_blank" rel="noopener">http://ttt.company.com/api/xxv/abc/feature</a></p>
<p><strong><em>ngin配置</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name admin-test.company.com;</span><br><span class="line"></span><br><span class="line">    location /api/abc &#123;</span><br><span class="line">        rewrite /api/abc/(.*) /api/xxv/$1 break;</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass http://staging.server.hostname:8080;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name admin.company.com;</span><br><span class="line"></span><br><span class="line">    location /api/abc &#123;</span><br><span class="line">        rewrite /api/abc/(.*) /api/xxv/$1 break;</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass http://myserver-write-nodes;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>###2. 服务端处理跨域请求##<br>在返回的response header中加入允许跨域访问的属性。例如：</p>
<p>Access-Control-Allow-Origin: {允许的域名}</p>
<p>更多信息参考：<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="noopener">跨域 HTTP 请求(Cross-site HTTP request)</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/网络/">网络</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/10/29/跨域请求/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/20/Btrace详解/" title="Btrace详解" itemprop="url">Btrace详解</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2015-08-20T08:01:19.000Z" itemprop="datePublished"> Published Aug 20 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>#1. Btrace的简介#<br>Btrace是由Kenai 开发的一个开源项目，是一种动态跟踪分析JAVA源代码的工具。它可以用来帮我们做运行时的JAVA程序分析，监控等等操作。</p>
<p>#2. 官方参考手册#<br><a href="https://kenai.com/projects/btrace/pages/UserGuide" target="_blank" rel="noopener">https://kenai.com/projects/btrace/pages/UserGuide</a></p>
<p>#3. 实例#</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.btrace.annotations.*;</span><br><span class="line">import com.sun.btrace.AnyType;</span><br><span class="line">import static com.sun.btrace.BTraceUtils.*;</span><br><span class="line"></span><br><span class="line">@BTrace</span><br><span class="line">public class TestServiceImplTrace &#123;</span><br><span class="line">    @TLS</span><br><span class="line">    private static long service_get_data_startTime = 0;</span><br><span class="line"></span><br><span class="line">    @OnMethod(</span><br><span class="line">            clazz = &quot;com.xxx.mms.test.impl.TestServiceImpl&quot;,</span><br><span class="line">            method = &quot;getTestData&quot;</span><br><span class="line">    )</span><br><span class="line">    public static void startTestServiceImplExecute() &#123;</span><br><span class="line">        section_facade_impl_startTime = timeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @OnMethod(</span><br><span class="line">            clazz = &quot;com.xxx.mms.test.impl.TestServiceImpl&quot;,</span><br><span class="line">            method = &quot;getTestData&quot;</span><br><span class="line">            location = @Location(Kind.RETURN)</span><br><span class="line">    )</span><br><span class="line">    public static void endTestServiceImplExecute(AnyType[] args) &#123; // 传入所有参数</span><br><span class="line">        long time = timeMillis() - section_facade_impl_startTime;</span><br><span class="line"></span><br><span class="line">        Object obj = args[4];</span><br><span class="line">        Integer end = (Integer)obj; // 将第5个参数转成Integer</span><br><span class="line"></span><br><span class="line">        printFields(args[0]); // 打印第1个参数的所有成员变量的值</span><br><span class="line"></span><br><span class="line">        if(end == 6)&#123;</span><br><span class="line">                print(strcat(“service getTestData execute time(millis): &quot;, str(time)));</span><br><span class="line">                print(strcat(“\t string param: &quot;, str(args[3]))); // 将第4个参数转成string并打印</span><br><span class="line">                println(strcat(“\t end: &quot;, str(end)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>#4. 心得#</p>
<ol>
<li>btrace脚本的函数都没有走进去时，btrace pid tracing.java 是得不到结果的。</li>
<li>Kind.LINE指向的行必须是代码能运行到的行。比如，以括号结束的行和空行都是无效的。</li>
<li>在刚启动btrace脚本监控时，会存在较大的耗时</li>
<li>print有很多功能：<br>  printNumberMap<br>  printFields： print 每个域<br>  printArray：print 数组</li>
<li>如果服务的qps较低(0.2),直接去机器上app222通过ip请求，btrace的event不好用也达不到触发某个请求的目的，这个时候可以直接在本机请求此server的api，虽然与实际情况不符，但是能知道耗时的比例关系。</li>
</ol>
<p>#5. Btrace的原理#<br>Btrace是由：Attach API + BTrace脚本解析引擎 + ASM + JDK6 Instumentation组成。简单来说就是：用Attach API附加*.jar然后使用BTrace脚本解析引擎 + ASM来实现对类的修改，在使用Instumentation实现类的内存替换。可详细的说明可以看refers的几篇文章。</p>
<p>#6. 使用Btrace对java进程的影响#</p>
<ul>
<li>装载时的影响：<br>btrace每次使用，都会重新load所有的class。当然如果OnMethod不匹配，是不会被重新装载。所以跟你的OnMethod的匹配规则很有关系，如果使用+java.lang.Object。那就死定了。</li>
<li>退出后的影响：<br>btrace监控每次退出后，原先所有的class都不会被恢复，你的所有的监控代码依然一直在运行</li>
</ul>
<p>抓取了下btrace改写过后的类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public InstrumentServer(String ip, String port)</span><br><span class="line">&#123;</span><br><span class="line">     $btrace$com$agapple$btrace$Instrumentor$InstrumentTracer$bufferMonitor(this);</span><br><span class="line">     this.ip = ip;</span><br><span class="line">     this.port = port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private static void $btrace$com$agapple$btrace$Instrumentor$InstrumentTracer$bufferMonitor(@Self Object arg0)</span><br><span class="line">&#123;</span><br><span class="line">     if (!BTraceRuntime.enter(InstrumentTracer.runtime)) return;</span><br><span class="line">     try &#123;</span><br><span class="line">          Field ipField = BTraceUtils.field(&quot;com.agapple.btrace.Instrumentor.InstrumentServer&quot;, &quot;ip&quot;);</span><br><span class="line">          Field portField = BTraceUtils.field(&quot;com.agapple.btrace.Instrumentor.InstrumentServer&quot;, &quot;port&quot;);</span><br><span class="line"> </span><br><span class="line">          String ip = (String)BTraceUtils.get(ipField, self);</span><br><span class="line">          String port = (String)BTraceUtils.get(portField, self);</span><br><span class="line"></span><br><span class="line">          BTraceUtils.println(BTraceUtils.strcat(BTraceUtils.strcat(BTraceUtils.strcat(&quot;ip : &quot;, BTraceUtils.str(ip)), &quot; port : &quot;), BTraceUtils.str(port)));</span><br><span class="line">          BTraceRuntime.leave(); return; &#125; catch (Throwable localThrowable) &#123; BTraceRuntime.handleException(localThrowable);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意其中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (!BTraceRuntime.enter(InstrumentTracer.runtime)) return;</span><br></pre></td></tr></table></figure>

<p>再看一下BTraceRuntime中对应方法的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private volatile boolean disabled;</span><br><span class="line">public static boolean enter(BTraceRuntime current) &#123;</span><br><span class="line">     if (current.disabled) return false;</span><br><span class="line">     return map.enter(current);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次执行你的监控代码之前会先进行一个判断，判断当前是否处于监控中。你的客户端发起了exit指令后，该方法判断false，直接return。</p>
<p><strong>所以btrace使用退出后会让你的代码多走了一个方法调用+一个对象属性判断，所以说影响还是非常少的。</strong></p>
<p>#7. 推荐阅读#<br>Btrace系列之一：Btrace的基本原理 <a href="http://victorzhzh.iteye.com/blog/965789" target="_blank" rel="noopener">http://victorzhzh.iteye.com/blog/965789</a><br>btrace一些你不知道的事(源码入手) <a href="http://agapple.iteye.com/blog/1005918" target="_blank" rel="noopener">http://agapple.iteye.com/blog/1005918</a></p>
<p>#refers#</p>
<blockquote>
</blockquote>
<p>Java SE 6 新特性: Instrumentation 新功能 <a href="http://www.ibm.com/developerworks/cn/java/j-lo-jse61/" target="_blank" rel="noopener">http://www.ibm.com/developerworks/cn/java/j-lo-jse61/</a><br>Btrace系列之一：Btrace的基本原理 <a href="http://victorzhzh.iteye.com/blog/965789" target="_blank" rel="noopener">http://victorzhzh.iteye.com/blog/965789</a><br>btrace一些你不知道的事(源码入手) <a href="http://agapple.iteye.com/blog/1005918" target="_blank" rel="noopener">http://agapple.iteye.com/blog/1005918</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/java/">java</a><a href="/tags/调试/">调试</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/08/20/Btrace详解/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/08/Spring注入/" title="Spring注入" itemprop="url">Spring注入</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2015-08-08T07:24:18.000Z" itemprop="datePublished"> Published Aug 8 2015</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>##1. 设值注入（推荐）##</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;myService&quot; class=&quot;com.zane.test.MyServiceImpl&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;serializer&quot; ref=&quot;Serializer&quot;/&gt;</span><br><span class="line">    &lt;property name=&quot;httpService&quot; ref=&quot;httpService&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>##2.  构造器注入（死的应用）##</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;myModel&quot; class=&quot;com.zane.test.MyModel&quot;&gt;</span><br><span class="line">    &lt;constructor-arg index=&quot;0&quot; value=&quot;$&#123;name&#125;&quot;/&gt;</span><br><span class="line">    &lt;constructor-arg index=&quot;1&quot; value=“20&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>##3. 注入List##</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;myTypes&quot; class=&quot;java.util.ArrayList&quot;&gt;</span><br><span class="line">    &lt;constructor-arg&gt;</span><br><span class="line">        &lt;list&gt;</span><br><span class="line">            &lt;value type=&quot;com.zane.test.MyType&quot;&gt;A&lt;/value&gt;</span><br><span class="line">            &lt;value type=&quot;com.zane.test.MyType&quot;&gt;B&lt;/value&gt;</span><br><span class="line">            &lt;value type=&quot;com.zane.test.MyType&quot;&gt;C&lt;/value&gt;</span><br><span class="line">        &lt;/list&gt;</span><br><span class="line">    &lt;/constructor-arg&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>##4. 注入Map##</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;myTypeValueMap&quot; class=&quot;java.util.HashMap&quot;&gt;</span><br><span class="line">    &lt;constructor-arg&gt;</span><br><span class="line">        &lt;map&gt;</span><br><span class="line">            &lt;entry key=&quot;#&#123;T(com.zane.test.MyType).A&#125;&quot;&gt;</span><br><span class="line">                &lt;value type=&quot;java.lang.Integer&quot;&gt;3&lt;/value&gt;</span><br><span class="line">            &lt;/entry&gt;</span><br><span class="line">            &lt;entry key=&quot;#&#123;T(com.zane.test.MyType).B&#125;&quot;&gt;</span><br><span class="line">                &lt;value type=&quot;java.lang.Integer&quot;&gt;4&lt;/value&gt;</span><br><span class="line">            &lt;/entry&gt;</span><br><span class="line">            &lt;entry key=&quot;#&#123;T(com.zane.test.MyType).C&#125;&quot;&gt;</span><br><span class="line">                &lt;value type=&quot;java.lang.Integer&quot;&gt;5&lt;/value&gt;</span><br><span class="line">            &lt;/entry&gt;</span><br><span class="line">        &lt;/map&gt;</span><br><span class="line">    &lt;/constructor-arg&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p><strong>当注入的是第三方的jar包的key类型时，需要使用@Resource注入</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@Resource</span><br><span class="line">@Qualifier(&quot;myTypeValueMap&quot;)</span><br><span class="line">private Map&lt;MyType, String&gt; myTypeValueMap;</span><br></pre></td></tr></table></figure>

<p>否则使用Autowired即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">@Qualifier(&quot;myTypeValueMap&quot;)</span><br><span class="line">private Map&lt;MyType, String&gt; myTypeValueMap;</span><br></pre></td></tr></table></figure>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Spring/">Spring</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2015/08/08/Spring注入/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/3/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/java/" title="java">java<sup>15</sup></a></li>
		
			<li><a href="/tags/机器学习/" title="机器学习">机器学习<sup>13</sup></a></li>
		
			<li><a href="/tags/算法/" title="算法">算法<sup>10</sup></a></li>
		
			<li><a href="/tags/多线程/" title="多线程">多线程<sup>6</sup></a></li>
		
			<li><a href="/tags/LeetCode/" title="LeetCode">LeetCode<sup>4</sup></a></li>
		
			<li><a href="/tags/调试/" title="调试">调试<sup>3</sup></a></li>
		
			<li><a href="/tags/分布式/" title="分布式">分布式<sup>3</sup></a></li>
		
			<li><a href="/tags/数学/" title="数学">数学<sup>3</sup></a></li>
		
			<li><a href="/tags/机器学习实战/" title="机器学习实战">机器学习实战<sup>3</sup></a></li>
		
			<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
		
			<li><a href="/tags/网络/" title="网络">网络<sup>2</sup></a></li>
		
			<li><a href="/tags/并发/" title="并发">并发<sup>1</sup></a></li>
		
			<li><a href="/tags/promote/" title="promote">promote<sup>1</sup></a></li>
		
			<li><a href="/tags/skill/" title="skill">skill<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>1</sup></a></li>
		
			<li><a href="/tags/Spring/" title="Spring">Spring<sup>1</sup></a></li>
		
			<li><a href="/tags/安全/" title="安全">安全<sup>1</sup></a></li>
		
			<li><a href="/tags/test/" title="test">test<sup>1</sup></a></li>
		
			<li><a href="/tags/spark/" title="spark">spark<sup>1</sup></a></li>
		
			<li><a href="/tags/Spark/" title="Spark">Spark<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m ljp215 Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Pacman">Jacman</a> © 2019 
		
		<a href="http://luojinping.com/about" target="_blank" title="Jinping Luo">Jinping Luo</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>





<script type="text/javascript">

var disqus_shortname = 'zane215';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<!-- MathJax End -->

  </body>
 </html>
