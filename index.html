
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Zane Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Jinping Luo">
    
    
    <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Zane Blog">
<meta property="og:url" content="http://luojinping.com/">
<meta property="og:site_name" content="Zane Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zane Blog">
<meta name="twitter:description">


    
    <link rel="alternative" href="/atom.xml" title="Zane Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a2d87d3add52ff134d9fac6cc16e4800";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Zane Blog" title="Zane Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Zane Blog">Zane Blog</a></h1>
				<h2 class="blog-motto">业精于勤荒于嬉，形成思毁于随</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:luojinping.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/08/19/lombok的AllArgsConstructor注解导致Jackson反序列化后丢失字段默认值/" title="lombok的AllArgsConstructor注解导致Jackson反序列化后丢失字段默认值" itemprop="url">lombok的AllArgsConstructor注解导致Jackson反序列化后丢失字段默认值</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2017-08-19T14:27:12.000Z" itemprop="datePublished"> Published Aug 19 2017</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="要解决的问题">要解决的问题</h1>
<p>希望在反序列化 json 为 bean 时，对于 json 中未出现的字段，在 bean 中赋上默认值。</p>
<p>例如<br>Person 类如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Data</span></div><div class="line"><span class="annotation">@AllArgsConstructor</span></div><div class="line"><span class="annotation">@NoArgsConstructor</span></div><div class="line"><span class="annotation">@JsonIgnoreProperties</span>(ignoreUnknown = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>{</div><div class="line">  <span class="keyword">private</span> String name;</div><div class="line">  <span class="keyword">private</span> String address = <span class="string">"beijing"</span>; <span class="comment">// default value if json missing the age field</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>json: </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">{"<span class="attribute">name</span>":<span class="value"><span class="string">"robert"</span></span>}</div></pre></td></tr></table></figure>

<p>反序列化后的 bean 为 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Person(<span class="variable">name=</span><span class="string">"robert"</span>, <span class="variable">address=</span><span class="string">"beijing"</span>)</div></pre></td></tr></table></figure>

<p>但实际上，发序列化的结果为</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Person(<span class="variable">name=</span><span class="string">"robert"</span>, <span class="variable">address=</span><span class="constant">null</span>)</div></pre></td></tr></table></figure>

<h1 id="解决过程">解决过程</h1>
<h2 id="1-_查看_maven_版本">1. 查看 maven 版本</h2>
<p>项目中 jackson 的配置如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">version</span>&gt;</span>${jackson.version}<span class="tag">&lt;/<span class="title">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">version</span>&gt;</span>${jackson.version}<span class="tag">&lt;/<span class="title">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">version</span>&gt;</span>${jackson.version}<span class="tag">&lt;/<span class="title">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- Jackson dependency versions --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">jackson.version</span>&gt;</span>2.6.5<span class="tag">&lt;/<span class="title">jackson.version</span>&gt;</span></div></pre></td></tr></table></figure>

<p>配置升到最新后问题仍然存在。</p>
<h2 id="2-_debug_json_反序列化过程，找到原因">2. debug json 反序列化过程，找到原因</h2>
<p>json 反序列化是从</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">com</span>.fasterxml.jackson.databind.ObjectMapper<span class="preprocessor">#_readMapAndClose</span></div></pre></td></tr></table></figure>

<p>这个方法调用开始的，里面的一段代码为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="type">DeserializationConfig</span> cfg = getDeserializationConfig();</div><div class="line"><span class="type">DeserializationContext</span> ctxt = createDeserializationContext(jp, cfg);</div><div class="line"><span class="type">JsonDeserializer</span>&lt;<span class="type">Object</span>&gt; deser = _findRootDeserializer(ctxt, valueType);</div><div class="line"><span class="keyword">if</span> (cfg.useRootWrapping()) {</div><div class="line">    <span class="literal">result</span> = _unwrapAndDeserialize(jp, ctxt, cfg, valueType, deser);</div><div class="line">} <span class="keyword">else</span> {</div><div class="line">    <span class="literal">result</span> = deser.deserialize(jp, ctxt);</div><div class="line">}</div><div class="line">ctxt.checkUnresolvedObjectId();</div></pre></td></tr></table></figure>

<p>在第 3 行找到的 JsonDeserializer 是 <code>com.fasterxml.jackson.databind.deser.BeanDeserializer</code><br>从第 7 行代表进入 <code>com.fasterxml.jackson.databind.deser.BeanDeserializer#deserialize(com.fasterxml.jackson.core.JsonParser, com.fasterxml.jackson.databind.DeserializationContext)</code></p>
<p>函数实现如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Object <span class="title">deserialize</span>(JsonParser p, DeserializationContext ctxt) <span class="keyword">throws</span> IOException {</div><div class="line">    <span class="comment">// common case first</span></div><div class="line">    <span class="keyword">if</span> (p.isExpectedStartObjectToken()) {</div><div class="line">        <span class="keyword">if</span> (_vanillaProcessing) {</div><div class="line">            <span class="keyword">return</span> vanillaDeserialize(p, ctxt, p.nextToken());</div><div class="line">        }</div><div class="line">        p.nextToken();</div><div class="line">        <span class="keyword">if</span> (_objectIdReader != <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">return</span> deserializeWithObjectId(p, ctxt);</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> deserializeFromObject(p, ctxt);</div><div class="line">    }</div><div class="line">    JsonToken t = p.getCurrentToken();</div><div class="line">    <span class="keyword">return</span> _deserializeOther(p, ctxt, t);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>vanillaDeserialize 为 false，最后走到了第 11 行，最后到了</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">com</span>.fasterxml.jackson.databind.deser.BeanDeserializer<span class="preprocessor">#_deserializeUsingPropertyBased</span></div></pre></td></tr></table></figure>

<p>然后到 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">com</span>.fasterxml.jackson.databind.deser.impl.PropertyBasedCreator<span class="preprocessor">#build</span></div></pre></td></tr></table></figure>

<p>在这个函数里有这样一段代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">Object bean </span>=<span class="string"> _valueInstantiator.createFromObjectWith(ctxt, buffer.getParameters(_allProperties));</span></div></pre></td></tr></table></figure>

<p>调用的是</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">com</span>.fasterxml.jackson.databind.deser.ValueInstantiator#createFromObjectWith(<span class="keyword">com</span>.fasterxml.jackson.databind.DeserializationContext, java.lang.Object[])</div></pre></td></tr></table></figure>

<p>可以发现，createFromObjectWith 的第二个参数是数组，json 解出来的字段都放在了这个数组里。然后调用了 Person 类的全参构造函数，对于<br>缺失的字段自动补 null 值，这样就导致了 address 字段为 null。</p>
<h2 id="3-_解决方案">3. 解决方案</h2>
<p>去掉 @AllArgsConstructor 时，没有问题了，因为此时找到的 <code>com.fasterxml.jackson.databind.deser.BeanDeserializer</code> 的  vanillaDeserialize 字段为 true，会调用 <code>vanillaDeserialize(p, ctxt, p.nextToken());</code>，这个函数的实现非常明确：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object <span class="title">vanillaDeserialize</span>(JsonParser p, DeserializationContext ctxt, JsonToken t) <span class="keyword">throws</span> IOException {</div><div class="line">        <span class="keyword">final</span> Object bean = _valueInstantiator.createUsingDefault(ctxt);</div><div class="line">        <span class="comment">// [databind#631]: Assign current value, to be accessible by custom serializers</span></div><div class="line">        p.setCurrentValue(bean);</div><div class="line">        <span class="keyword">if</span> (p.hasTokenId(JsonTokenId.ID_FIELD_NAME)) {</div><div class="line">            String propName = p.getCurrentName();</div><div class="line">            do {</div><div class="line">                p.nextToken();</div><div class="line">                SettableBeanProperty prop = _beanProperties.find(propName);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (prop != <span class="keyword">null</span>) { <span class="comment">// normal case</span></div><div class="line">                    <span class="keyword">try</span> {</div><div class="line">                        prop.deserializeAndSet(p, ctxt, bean);</div><div class="line">                    } <span class="keyword">catch</span> (Exception e) {</div><div class="line">                        wrapAndThrow(e, bean, propName, ctxt);</div><div class="line">                    }</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                }</div><div class="line">                handleUnknownVanilla(p, ctxt, bean, propName);</div><div class="line">            } <span class="keyword">while</span> ((propName = p.nextFieldName()) != <span class="keyword">null</span>);</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> bean;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>先用默认构造函数生成 bean，此时的 bean 是有默认值的，然后将 json 中出现的字段的值赋值给 bean，这样 address 就有值了。</p>
<h2 id="4-_根本原因">4. 根本原因</h2>
<p>看上去是声明了全参构造函数导致的，所以想尝试自己写全参构造函数，在 address 为 null 时给其赋默认值。<br>写完如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="title">Person</span>(String name, String address){</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.address = address;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.address == <span class="keyword">null</span>){</div><div class="line">            <span class="keyword">this</span>.address = <span class="string">"beijing"</span>;</div><div class="line">        }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>继续走刚才 debug 的流程，发现<strong>居然</strong>没有请求这个全参构造函数。</p>
<p>那问题就是 @AllArgsConstructor 生成的全参函数有不同之处，jackson 能够识别出来并用于反序列化。查看 jar 包中 Person 类的代码发现其全参构造函数如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@ConstructorProperties</span>({<span class="string">"name"</span>, <span class="string">"address"</span>})</div><div class="line"><span class="keyword">public</span> <span class="title">Person</span>(String name, String address){</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.address = address;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>所以，区别就是 <code>@ConstructorProperties({&quot;name&quot;, &quot;address&quot;})</code> 这个注解，这个注解的作用是指定构造函数参数的名字，Spring 可根据参数的名字注入 bean。<br>但最终为什么这样注解了，jackson 就调用了全参构造函数还不得而知，猜测是 jackson 在 <code>_findRootDeserializer</code> 这一步时，是找最适合的构造函数。</p>
<p>可以通过设置 @AllArgsConstructor(suppressConstructorProperties=true) 来禁用 @ConstructorProperties.</p>
<h1 id="结论">结论</h1>
<p>Lombok 的 @AllArgsConstructor 注解导致 Jackson 反序列化时调用了全参构造函数，将没有出现的字段都赋值为 null 了。</p>
<p>修改方式：</p>
<ol>
<li>不使用 @AllArgsConstructor</li>
<li>使用 @AllArgsConstructor 但是不让其在全参构造函数上加入 ConstructorProperties 注解，声明方式改为 @AllArgsConstructor(suppressConstructorProperties = true)</li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/java/">java</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/08/19/lombok的AllArgsConstructor注解导致Jackson反序列化后丢失字段默认值/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/08/13/服务调优/" title="服务调优" itemprop="url">服务调优</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2017-08-13T13:03:50.000Z" itemprop="datePublished"> Published Aug 13 2017</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="目录">目录</h1>
<ol>
<li>服务异常的处理流程</li>
<li>负载</li>
<li>内存</li>
<li>服务指标</li>
<li>工具</li>
</ol>
<h1 id="1-_服务异常的处理流程">1. 服务异常的处理流程</h1>
<p><img src="/img/server_debug_online.jpg" alt=""></p>
<h1 id="2-_负载">2. 负载</h1>
<h2 id="2-1_查看机器_cpu_的负载">2.1 查看机器 cpu 的负载</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">top -b -n <span class="number">1</span> |grep java|awk '{<span class="literal">print</span> <span class="string">"VIRT:"</span><span class="variable">$5</span>,<span class="string">"RES:"</span><span class="variable">$6</span>,<span class="string">"cpu:"</span><span class="variable">$9</span><span class="string">"%"</span>,<span class="string">"mem:"</span><span class="variable">$10</span><span class="string">"%"</span>}'</div></pre></td></tr></table></figure>

<h2 id="2-2_查找_cpu_占用率高的线程">2.2 查找 cpu 占用率高的线程</h2>
<p>top -p 25603 -H<br>printf 0x%x 25842<br>jstack 25603 | grep 0x64f2</p>
<p>cat /proc/interrupts</p>
<p>（1）CPU<br>（2）Memory<br>（3）IO<br>（4）Network</p>
<p>可以从以下几个方面监控CPU的信息：<br>（1）中断；<br>（2）上下文切换；<br>（3）可运行队列；<br>（4）CPU 利用率。</p>
<h1 id="3-_内存">3. 内存</h1>
<h2 id="3-1_系统内存">3.1 系统内存</h2>
<p>free 命令<br>[root@server ~]# free</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">             total       used       free     shared    buffers     cached</div><div class="line">Mem:       3266180    3250000      10000          0     201000    3002000</div><div class="line">-<span class="ruby">/+ buffers/<span class="symbol">cache:</span>      <span class="number">47000</span>    <span class="number">3213000</span></span></div><div class="line">Swap:      2048276      80160    1968116</div></pre></td></tr></table></figure>

<p>这里的默认显示单位是kb。<br>各项指标解释</p>
<ul>
<li>total:总计物理内存的大小。</li>
<li>used:已使用多大。</li>
<li>free:可用有多少。</li>
<li>Shared:多个进程共享的内存总额。</li>
<li>buffers: 磁盘缓存的大小。</li>
<li>cache:磁盘缓存的大小。</li>
<li>-/+ buffers/cached): used:已使用多大，free:可用有多少。</li>
<li>已用内存 = 系统used memory - buffers - cached<br>（47000 = 3250000-201000-3002000）</li>
<li>可用内存 = 系统free memory + buffers + cached<br>（3213000 = 10000+201000+3002000）</li>
</ul>
<h4 id="什么是buffer/cache？">什么是buffer/cache？</h4>
<ul>
<li>buffer 指 Linux 内存的：Buffer cache，缓冲区缓</li>
<li>cache 指 Linux内存中的：Page cache，页面缓存</li>
</ul>
<p><strong>page cache</strong><br>page cache 主要用来作为<strong>文件系统上的文件数据的缓存</strong>来用，尤其是针对当进程对文件有 read／write 操作的时候。如果你仔细想想的话，作为可以映射文件到内存的系统调用：mmap是不是很自然的也应该用到 page cache？在当前的系统实现里，page cache 也被作为其它文件类型的缓存设备来用，所以事实上 page cache 也负责了大部分的块设备文件的缓存工作。</p>
<p><strong>buffer cache</strong><br>buffer cache 主要用来在<strong>系统对块设备进行读写</strong>的时候，对块进行数据缓存的系统来使用。这意味着某些对块的操作会使用 buffer cache 进行缓存，比如我们在格式化文件系统的时候。一般情况下两个缓存系统是一起配合使用的，比如当我们对一个文件进行写操作的时候，page cache 的内容会被改变，而 buffer cache 则可以用来将 page 标记为不同的缓冲区，并记录是哪一个缓冲区被修改了。这样，内核在后续执行脏数据的回写（writeback）时，就不用将整个 page 写回，而只需要写回修改的部分即可。</p>
<p>在当前的内核中，page cache 是针对内存页的缓存，说白了就是，如果有内存是以page进行分配管理的，都可以使用page cache作为其缓存来管理使用。<br>当然，不是所有的内存都是以页（page）进行管理的，也有很多是针对块（block）进行管理的，这部分内存使用如果要用到 cache 功能，则都集中到buffer cache中来使用。（从这个角度出发，是不是buffer cache改名叫做block cache更好？）然而，也不是所有块（block）都有固定长度，系统上块的长度主要是根据所使用的块设备决定的，而页长度在X86上无论是32位还是64位都是4k。</p>
<h4 id="系统如何回收cache？">系统如何回收cache？</h4>
<p>Linux内核会在内存将要耗尽的时候，触发内存回收的工作，以便释放出内存给急需内存的进程使用。一般情况下，这个操作中主要的内存释放都来自于对buffer／cache的释放。尤其是被使用更多的cache空间。既然它主要用来做缓存，只是在内存够用的时候加快进程对文件的读写速度，那么在内存压力较大的情况下，当然有必要清空释放cache，作为free空间分给相关进程使用。所以一般情况下，我们认为buffer/cache空间可以被释放，这个理解是正确的。</p>
<p>但是这种清缓存的工作也并不是没有成本。理解cache是干什么的就可以明白清缓存必须保证cache中的数据跟对应文件中的数据一致，才能对cache进行释放。所以伴随着cache清除的行为的，一般都是系统IO飙高。因为内核要对比cache中的数据和对应硬盘文件上的数据是否一致，如果不一致需要写回，之后才能回收。</p>
<p>在系统中除了内存将被耗尽的时候可以清缓存以外，我们还可以人工触发缓存清除的操作。</p>
<h2 id="3-2_进程内存">3.2 进程内存</h2>
<h3 id="3-2-1_进程内存统计">3.2.1 进程内存统计</h3>
<p>/proc/[pid]/status<br>通过/proc/<pid>/status可以查看进程的内存使用情况，包括虚拟内存大小（VmSize），物理内存大小（VmRSS），数据段大小（VmData），栈的大小（VmStk），代码段的大小（VmExe），共享库的代码段大小（VmLib）等等。</pid></p>
<p>cat /proc/[pid]/status</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">Name</span>: <span class="string">gedit /*进程的程序名*/</span></div><div class="line"><span class="attribute">State</span>: <span class="string">S (sleeping) /*进程的状态信息,具体参见http://blog.chinaunix.net/u2/73528/showart_1106510.html*/</span></div><div class="line"><span class="attribute">Tgid</span>: <span class="string">9744 /*线程组号*/</span></div><div class="line"><span class="attribute">Pid</span>: <span class="string">9744 /*进程pid*/</span></div><div class="line"><span class="attribute">PPid</span>: <span class="string">7672 /*父进程的pid*/</span></div><div class="line"><span class="attribute">TracerPid</span>: <span class="string">0 /*跟踪进程的pid*/</span></div><div class="line"><span class="attribute">VmPeak</span>: <span class="string">60184 kB /*进程地址空间的大小*/</span></div><div class="line"><span class="attribute">VmSize</span>: <span class="string">60180 kB /*进程虚拟地址空间的大小reserved_vm：进程在预留或特殊的内存间的物理页*/</span></div><div class="line"><span class="attribute">VmLck</span>: <span class="string">0 kB /*进程已经锁住的物理内存的大小.锁住的物理内存不能交换到硬盘*/</span></div><div class="line"><span class="attribute">VmHWM</span>: <span class="string">18020 kB /*文件内存映射和匿名内存映射的大小*/</span></div><div class="line"><span class="attribute">VmRSS</span>: <span class="string">18020 kB /*应用程序正在使用的物理内存的大小，就是用ps命令的参数rss的值 (rss)*/</span></div><div class="line"><span class="attribute">VmData</span>: <span class="string">12240 kB /*程序数据段的大小（所占虚拟内存的大小），存放初始化了的数据*/</span></div><div class="line"><span class="attribute">VmStk</span>: <span class="string">84 kB /*进程在用户态的栈的大小*/</span></div><div class="line"><span class="attribute">VmExe</span>: <span class="string">576 kB /*程序所拥有的可执行虚拟内存的大小,代码段,不包括任务使用的库 */</span></div><div class="line"><span class="attribute">VmLib</span>: <span class="string">21072 kB /*被映像到任务的虚拟内存空间的库的大小*/</span></div><div class="line"><span class="attribute">VmPTE</span>: <span class="string">56 kB /*该进程的所有页表的大小*/</span></div><div class="line"><span class="attribute">Threads</span>: <span class="string">1 /*共享使用该信号描述符的任务的个数*/</span></div></pre></td></tr></table></figure>

<h3 id="3-2-2_JVM_内存分配">3.2.2 JVM 内存分配</h3>
<p>java内存组成介绍：堆(Heap)和非堆(Non-heap)内存</p>
<p>按照官方的说法：“Java 虚拟机具有一个堆，堆是运行时数据区域，所有类实例和数组的内存均从此处分配。堆是在 Java 虚拟机启动时创建的。”“在JVM中堆之外的内存称为非堆内存(Non-heap memory)”。可以看出JVM主要管理两种类型的内存：堆和非堆。简单来说堆就是Java代码可及的内存，是留给开发人员使用的；非堆就是JVM留给 自己用的，所以方法区、JVM内部处理或优化所需的内存(如JIT编译后的代码缓存)、每个类结构(如运行时常数池、字段和方法数据)以及方法和构造方法 的代码都在非堆内存中。</p>
<p><img src="quiver-image-url/590323FD2C5869E67568351DED266A03.jpg =501x363" alt="IMAGE"></p>
<ol>
<li>JVM本身需要的内存，包括其加载的第三方库以及这些库分配的内存</li>
<li>NIO的DirectBuffer是分配的native memory</li>
<li>内存映射文件，包括JVM加载的一些JAR和第三方库，以及程序内部用到的。上面 pmap 输出的内容里，有一些静态文件所占用的大小不在Java的heap里，因此作为一个Web服务器，赶紧把静态文件从这个Web服务器中人移开吧，放到nginx或者CDN里去吧。</li>
<li>JIT， JVM会将Class编译成native代码，这些内存也不会少，如果使用了Spring的AOP，CGLIB会生成更多的类，JIT的内存开销也会随之变大，而且Class本身JVM的GC会将其放到Perm Generation里去，很难被回收掉，面对这种情况，应该让JVM使用ConcurrentMarkSweep GC，并启用这个GC的相关参数允许将不使用的class从Perm Generation中移除， 参数配置： -XX:+UseConcMarkSweepGC -X:+CMSPermGenSweepingEnabled -X:+CMSClassUnloadingEnabled，如果不需要移除而Perm Generation空间不够，可以加大一点： -X:PermSize=256M -X:MaxPermSize=512M</li>
<li>JNI，一些JNI接口调用的native库也会分配一些内存，如果遇到JNI库的内存泄露，可以使用valgrind等内存泄露工具来检测</li>
<li>线程栈，每个线程都会有自己的栈空间，如果线程一多，这个的开销就很明显了</li>
<li>jmap/jstack 采样，频繁的采样也会增加内存占用，如果你有服务器健康监控，记得这个频率别太高，否则健康监控变成致病监控了。</li>
</ol>
<h4 id="1-方法区">1.方法区</h4>
<p>也称”永久代” 、“非堆”，它用于存储虚拟机加载的类信息、常量、静态变量、是各个线程共享的内存区域。默认最小值为16MB，最大值为64MB，可以通过-XX:PermSize 和 -XX:MaxPermSize 参数限制方法区的大小。</p>
<p>运行时常量池：是方法区的一部分，Class文件中除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池，用于存放编译器生成的各种符号引用，这部分内容将在类加载后放到方法区的运行时常量池中。</p>
<h4 id="2-虚拟机栈">2.虚拟机栈</h4>
<p>描述的是java 方法执行的内存模型：每个方法被执行的时候 都会创建一个“栈帧”用于存储局部变量表(包括参数)、操作栈、方法出口等信息。每个方法被调用到执行完的过程，就对应着一个栈帧在虚拟机栈中从入栈到出栈的过程。声明周期与线程相同，是线程私有的。</p>
<p>局部变量表存放了编译器可知的各种基本数据类型(boolean、byte、char、short、int、float、long、double)、对象引用(引用指针，并非对象本身)，其中64位长度的long和double类型的数据会占用2个局部变量的空间，其余数据类型只占1个。局部变量表所需的内存空间在编译期间完成分配，当进入一个方法时，这个方法需要在栈帧中分配多大的局部变量是完全确定的，在运行期间栈帧不会改变局部变量表的大小空间。</p>
<h4 id="3-本地方法栈">3.本地方法栈</h4>
<p>与虚拟机栈基本类似，区别在于虚拟机栈为虚拟机执行的java方法服务，而本地方法栈则是为Native方法服务。</p>
<h4 id="4-堆">4.堆</h4>
<p>也叫做java 堆、GC堆是java虚拟机所管理的内存中最大的一块内存区域，也是被各个线程共享的内存区域，在JVM启动时创建。该内存区域存放了对象实例及数组(所有new的对象)。其大小通过-Xms(最小值)和-Xmx(最大值)参数设置，-Xms为JVM启动时申请的最小内存，默认为操作系统物理内存的1/64但小于1G，-Xmx为JVM可申请的最大内存，默认为物理内存的1/4但小于1G，默认当空余堆内存小于40%时，JVM会增大Heap到-Xmx指定的大小，可通过-XX:MinHeapFreeRation=来指定这个比列；当空余堆内存大于70%时，JVM会减小heap的大小到-Xms指定的大小，可通过XX:MaxHeapFreeRation=来指定这个比列，对于运行系统，为避免在运行时频繁调整Heap的大小，通常-Xms与-Xmx的值设成一样。</p>
<p>由于现在收集器都是采用分代收集算法，堆被划分为新生代和老年代。新生代主要存储新创建的对象和尚未进入老年代的对象。老年代存储经过多次新生代GC(Minor GC)任然存活的对象。</p>
<h4 id="5-程序计数器">5.程序计数器</h4>
<p>是最小的一块内存区域，它的作用是当前线程所执行的字节码的行号指示器，在虚拟机的模型里，字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、异常处理、线程恢复等基础功能都需要依赖计数器完成。</p>
<h4 id="3-2-3_直接内存">3.2.3 直接内存</h4>
<p>直接内存并不是虚拟机内存的一部分，也不是Java虚拟机规范中定义的内存区域。jdk1.4中新加入的NIO，引入了通道与缓冲区的IO方式，它可以调用Native方法直接分配堆外内存，这个堆外内存就是本机内存，不会影响到堆内存的大小。</p>
<h3 id="3-2-4_JVM_内存分析">3.2.4 JVM 内存分析</h3>
<h4 id="查看_JVM_堆内存情况">查看 JVM 堆内存情况</h4>
<p>jmap -heap [pid]</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">[root@server ~]$ jmap -heap <span class="number">837</span></div><div class="line">Attaching to process ID <span class="number">837</span>, please wait...</div><div class="line">Debugger attached successfully.</div><div class="line">Server compiler detected.</div><div class="line">JVM version is <span class="number">24.71</span>-b01</div><div class="line"></div><div class="line">using thread-local object allocation.</div><div class="line">Parallel GC <span class="keyword">with</span> <span class="number">4</span> thread(s)//GC 方式</div><div class="line"></div><div class="line">Heap Configuration: //堆内存初始化配置</div><div class="line">   <span class="variable">MinHeapFreeRatio =</span> <span class="number">0</span> //对应jvm启动参数-XX:MinHeapFreeRatio设置JVM堆最小空闲比率(default <span class="number">40</span>)</div><div class="line">   <span class="variable">MaxHeapFreeRatio =</span> <span class="number">100</span> //对应jvm启动参数 -XX:MaxHeapFreeRatio设置JVM堆最大空闲比率(default <span class="number">70</span>)</div><div class="line">   <span class="variable">MaxHeapSize      =</span> <span class="number">2082471936</span> (<span class="number">1986.0</span>MB) //对应jvm启动参数-XX:<span class="variable">MaxHeapSize=</span>设置JVM堆的最大大小</div><div class="line">   <span class="variable">NewSize          =</span> <span class="number">1310720</span> (<span class="number">1.25</span>MB)//对应jvm启动参数-XX:<span class="variable">NewSize=</span>设置JVM堆的‘新生代’的默认大小</div><div class="line">   <span class="variable">MaxNewSize       =</span> <span class="number">17592186044415</span> MB//对应jvm启动参数-XX:<span class="variable">MaxNewSize=</span>设置JVM堆的‘新生代’的最大大小</div><div class="line">   <span class="variable">OldSize          =</span> <span class="number">5439488</span> (<span class="number">5.1875</span>MB)//对应jvm启动参数-XX:<span class="variable">OldSize=</span>&lt;value&gt;:设置JVM堆的‘老生代’的大小</div><div class="line">   <span class="variable">NewRatio         =</span> <span class="number">2</span> //对应jvm启动参数-XX:<span class="variable">NewRatio=</span>:‘新生代’和‘老生代’的大小比率</div><div class="line">   <span class="variable">SurvivorRatio    =</span> <span class="number">8</span> //对应jvm启动参数-XX:<span class="variable">SurvivorRatio=</span>设置年轻代中Eden区与Survivor区的大小比值 </div><div class="line">   <span class="variable">PermSize         =</span> <span class="number">21757952</span> (<span class="number">20.75</span>MB)  //对应jvm启动参数-XX:<span class="variable">PermSize=</span>&lt;value&gt;:设置JVM堆的‘永生代’的初始大小</div><div class="line">   <span class="variable">MaxPermSize      =</span> <span class="number">85983232</span> (<span class="number">82.0</span>MB)//对应jvm启动参数-XX:<span class="variable">MaxPermSize=</span>&lt;value&gt;:设置JVM堆的‘永生代’的最大大小</div><div class="line">   <span class="variable">G1HeapRegionSize =</span> <span class="number">0</span> (<span class="number">0.0</span>MB)</div><div class="line"></div><div class="line">Heap Usage://堆内存使用情况</div><div class="line">PS Young Generation</div><div class="line">Eden Space://Eden区内存分布</div><div class="line">   <span class="variable">capacity =</span> <span class="number">33030144</span> (<span class="number">31.5</span>MB)//Eden区总容量</div><div class="line">   <span class="variable">used     =</span> <span class="number">1524040</span> (<span class="number">1.4534378051757812</span>MB)  //Eden区已使用</div><div class="line">   <span class="variable">free     =</span> <span class="number">31506104</span> (<span class="number">30.04656219482422</span>MB)  //Eden区剩余容量</div><div class="line">   <span class="number">4.614088270399305</span>% used //Eden区使用比率</div><div class="line">From Space:  //其中一个Survivor区的内存分布</div><div class="line">   <span class="variable">capacity =</span> <span class="number">5242880</span> (<span class="number">5.0</span>MB)</div><div class="line">   <span class="variable">used     =</span> <span class="number">0</span> (<span class="number">0.0</span>MB)</div><div class="line">   <span class="variable">free     =</span> <span class="number">5242880</span> (<span class="number">5.0</span>MB)</div><div class="line">   <span class="number">0.0</span>% used</div><div class="line">To Space:  //另一个Survivor区的内存分布</div><div class="line">   <span class="variable">capacity =</span> <span class="number">5242880</span> (<span class="number">5.0</span>MB)</div><div class="line">   <span class="variable">used     =</span> <span class="number">0</span> (<span class="number">0.0</span>MB)</div><div class="line">   <span class="variable">free     =</span> <span class="number">5242880</span> (<span class="number">5.0</span>MB)</div><div class="line">   <span class="number">0.0</span>% used</div><div class="line">PS Old Generation //当前的Old区内存分布</div><div class="line">   <span class="variable">capacity =</span> <span class="number">86507520</span> (<span class="number">82.5</span>MB)</div><div class="line">   <span class="variable">used     =</span> <span class="number">0</span> (<span class="number">0.0</span>MB)</div><div class="line">   <span class="variable">free     =</span> <span class="number">86507520</span> (<span class="number">82.5</span>MB)</div><div class="line">   <span class="number">0.0</span>% used</div><div class="line">PS Perm Generation//当前的 “永生代” 内存分布</div><div class="line">   <span class="variable">capacity =</span> <span class="number">22020096</span> (<span class="number">21.0</span>MB)</div><div class="line">   <span class="variable">used     =</span> <span class="number">2496528</span> (<span class="number">2.3808746337890625</span>MB)</div><div class="line">   <span class="variable">free     =</span> <span class="number">19523568</span> (<span class="number">18.619125366210938</span>MB)</div><div class="line">   <span class="number">11.337498256138392</span>% used</div><div class="line"></div><div class="line"><span class="number">670</span> interned Strings occupying <span class="number">43720</span> bytes.</div></pre></td></tr></table></figure>

<p>关于这里的几个generation网上资料一大把就不细说了，这里算一下求和可以得知前者总共给Java环境分配了644M的内存，而ps输出的VSZ和RSS分别是7.4G和2.9G，这到底是怎么回事呢？<br>前面jmap输出的内容里，MaxHeapSize 是在命令行上配的，-Xmx4096m，这个java程序可以用到的最大堆内存。<br>VSZ是指已分配的线性空间大小，这个大小通常并不等于程序实际用到的内存大小，产生这个的可能性很多，比如内存映射，共享的动态库，或者向系统申请了更多的堆，都会扩展线性空间大小，要查看一个进程有哪些内存映射，可以使用 pmap 命令来查看：<br>pmap -x [pid]</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@server ~]$ pmap -x <span class="number">837</span></div><div class="line"><span class="number">837</span>:   java</div><div class="line">Address           Kbytes     RSS   Dirty Mode   Mapping</div><div class="line"><span class="number">0000000040000000</span>      <span class="number">36</span>       <span class="number">4</span>       <span class="number">0</span> r-x--  java</div><div class="line"><span class="number">0000000040108000</span>       <span class="number">8</span>       <span class="number">8</span>       <span class="number">8</span> rwx--  java</div><div class="line">00000000418c9000   <span class="number">13676</span>   <span class="number">13676</span>   <span class="number">13676</span> rwx--    [ anon ]</div><div class="line">00000006fae00000   <span class="number">83968</span>   <span class="number">83968</span>   <span class="number">83968</span> rwx--    [ anon ]</div><div class="line"><span class="number">0000000700000000</span>  <span class="number">527168</span>  <span class="number">451636</span>  <span class="number">451636</span> rwx--    [ anon ]</div><div class="line">00000007202d0000  <span class="number">127040</span>       <span class="number">0</span>       <span class="number">0</span> -----    [ anon ]</div><div class="line"><span class="keyword">...</span></div><div class="line"><span class="keyword">...</span></div><div class="line">00007f55ee124000       <span class="number">4</span>       <span class="number">4</span>       <span class="number">0</span> r-xs-  az.png</div><div class="line">00007fff017ff000       <span class="number">4</span>       <span class="number">4</span>       <span class="number">0</span> r-x--    [ anon ]</div><div class="line">ffffffffff600000       <span class="number">4</span>       <span class="number">0</span>       <span class="number">0</span> r-x--    [ anon ]</div><div class="line">----------------  ------  ------  ------</div><div class="line">total kB         <span class="number">7796020</span> <span class="number">3037264</span> <span class="number">3023928</span></div></pre></td></tr></table></figure>

<p>这里可以看到很多anon，这些表示这块内存是由mmap分配的。</p>
<p>RSZ是Resident Set Size，常驻内存大小，即进程实际占用的物理内存大小， 在现在这个例子当中，RSZ和实际堆内存占用差了2.3G，这2.3G的内存组成分别为：</p>
<h4 id="查看_JVM_堆各个分区的内存情况">查看 JVM 堆各个分区的内存情况</h4>
<p>jstat -gcutil [pid]</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@server</span> ~]<span class="variable">$ </span>jstat -gcutil <span class="number">837</span> <span class="number">1000</span> <span class="number">20</span></div><div class="line">  <span class="constant">S0</span>     <span class="constant">S1</span>     <span class="constant">E</span>      <span class="constant">O</span>      <span class="constant">P</span>     <span class="constant">YGC</span>     <span class="constant">YGCT</span>    <span class="constant">FGC</span>    <span class="constant">FGCT</span>     <span class="constant">GCT</span>   </div><div class="line">  <span class="number">0</span>.<span class="number">00</span>  <span class="number">80.43</span>  <span class="number">24.62</span>  <span class="number">87.44</span>  <span class="number">98.29</span>   <span class="number">7101</span>  <span class="number">119.652</span>    <span class="number">40</span>   <span class="number">19.719</span>  <span class="number">139.371</span></div><div class="line">  <span class="number">0</span>.<span class="number">00</span>  <span class="number">80.43</span>  <span class="number">33.14</span>  <span class="number">87.44</span>  <span class="number">98.29</span>   <span class="number">7101</span>  <span class="number">119.652</span>    <span class="number">40</span>   <span class="number">19.719</span>  <span class="number">139.371</span></div></pre></td></tr></table></figure>

<h4 id="分析_JVM_堆内存中的对象">分析 JVM 堆内存中的对象</h4>
<p><strong>查看存活的对象统计</strong><br>jmap -histo:live [pid]</p>
<p><strong>dump 内存</strong><br>jmap -dump:format=b,file=heapDump [pid]</p>
<p>然后用jhat命令可以参看<br>jhat -port 5000 heapDump<br>在浏览器中访问：<a href="http://localhost:5000/" target="_blank" rel="external">http://localhost:5000/</a> 查看详细信息</p>
<h1 id="4-_服务指标">4. 服务指标</h1>
<h2 id="4-1_响应时间(RT)">4.1 响应时间(RT)</h2>
<p>响应时间是指系统对请求作出响应的时间。直观上看，这个指标与人对软件性能的主观感受是非常一致的，因为它完整地记录了整个计算机系统处理请求的时间。由于一个系统通常会提供许多功能，而不同功能的处理逻辑也千差万别，因而不同功能的响应时间也不尽相同，甚至同一功能在不同输入数据的情况下响应时间也不相同。所以，在讨论一个系统的响应时间时，人们通常是指该系统所有功能的平均时间或者所有功能的最大响应时间。当然，往往也需要对每个或每组功能讨论其平均响应时间和最大响应时间。</p>
<p>对于单机的没有并发操作的应用系统而言，人们普遍认为响应时间是一个合理且准确的性能指标。需要指出的是，响应时间的绝对值并不能直接反映软件的性能的高低，软件性能的高低实际上取决于用户对该响应时间的接受程度。对于一个游戏软件来说，响应时间小于100毫秒应该是不错的，响应时间在1秒左右可能属于勉强可以接受，如果响应时间达到3秒就完全难以接受了。而对于编译系统来说，完整编译一个较大规模软件的源代码可能需要几十分钟甚至更长时间，但这些响应时间对于用户来说都是可以接受的。</p>
<h2 id="4-2_吞吐量(Throughput)">4.2 吞吐量(Throughput)</h2>
<p>吞吐量是指系统在单位时间内处理请求的数量。对于无并发的应用系统而言，吞吐量与响应时间成严格的反比关系，实际上此时吞吐量就是响应时间的倒数。前面已经说过，对于单用户的系统，响应时间（或者系统响应时间和应用延迟时间）可以很好地度量系统的性能，但对于并发系统，通常需要用吞吐量作为性能指标。</p>
<p>对于一个多用户的系统，如果只有一个用户使用时系统的平均响应时间是t，当有你n个用户使用时，每个用户看到的响应时间通常并不是n×t，而往往比n×t小很多（当然，在某些特殊情况下也可能比n×t大，甚至大很多）。这是因为处理每个请求需要用到很多资源，由于每个请求的处理过程中有许多不走难以并发执行，这导致在具体的一个时间点，所占资源往往并不多。也就是说在处理单个请求时，在每个时间点都可能有许多资源被闲置，当处理多个请求时，如果资源配置合理，每个用户看到的平均响应时间并不随用户数的增加而线性增加。实际上，不同系统的平均响应时间随用户数增加而增长的速度也不大相同，这也是采用吞吐量来度量并发系统的性能的主要原因。一般而言，吞吐量是一个比较通用的指标，两个具有不同用户数和用户使用模式的系统，如果其最大吞吐量基本一致，则可以判断两个系统的处理能力基本一致。</p>
<h2 id="4-3_并发用户数">4.3 并发用户数</h2>
<p>并发用户数是指系统可以同时承载的正常使用系统功能的用户的数量。与吞吐量相比，并发用户数是一个更直观但也更笼统的性能指标。实际上，并发用户数是一个非常不准确的指标，因为用户不同的使用模式会导致不同用户在单位时间发出不同数量的请求。一网站系统为例，假设用户只有注册后才能使用，但注册用户并不是每时每刻都在使用该网站，因此具体一个时刻只有部分注册用户同时在线，在线用户就在浏览网站时会花很多时间阅读网站上的信息，因而具体一个时刻只有部分在线用户同时向系统发出请求。这样，对于网站系统我们会有三个关于用户数的统计数字：注册用户数、在线用户数和同时发请求用户数。由于注册用户可能长时间不登陆网站，使用注册用户数作为性能指标会造成很大的误差。而在线用户数和同事发请求用户数都可以作为性能指标。相比而言，以在线用户作为性能指标更直观些，而以同时发请求用户数作为性能指标更准确些。</p>
<h2 id="4-4_QPS每秒查询率(Query_Per_Second)">4.4 QPS每秒查询率(Query Per Second)</h2>
<p>每秒查询率QPS是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准，在因特网上，作为域名系统服务器的机器的性能经常用每秒查询率来衡量。对应fetches/sec，即每秒的响应请求数，也即是最大吞吐能力。</p>
<p>从以上概念来看吞吐量和响应时间是衡量系统性能的重要指标，QPS虽然和吞吐量的计量单位不同，但应该是成正比的，任何一个指标都可以含量服务器的并行处理能力。当然Throughput更关心数据量，QPS更关心处理笔数。</p>
<h2 id="4-5_CPU利用率">4.5 CPU利用率</h2>
<p>CPU Load Average &lt; CPU个数 <em> 核数 </em> 0.7 </p>
<p><strong>Context Switch Rate</strong><br>就是Process（Thread）的切换，如果切换过多，会让CPU忙于切换，也会导致影响吞吐量。《高性能服务器架构 》这篇文章的第2节就是说的是这个问题的。究竟多少算合适？google了一大圈，没有一个确切的解释。Context Switch大体上由两个部分组成：中断和进程(包括线程)切换，一次中断（Interrupt）会引起一次切换，进程（线程）的创建、激活之类的也会引起一次切换。CS的值也和TPS（Transaction Per Second）相关的，假设每次调用会引起N次CS，那么就可以得出</p>
<p>Context Switch Rate = Interrupt Rate + TPS* N</p>
<p>CSR减掉IR，就是进程/线程的切换，假如主进程收到请求交给线程处理，线程处理完毕归还给主进程，这里就是2次切换。也可以用CSR、IR、TPS的值代入公式中，得出每次事物导致的切换数。因此，要降低CSR，就必须在每个TPS引起的切换上下功夫，只有N这个值降下去，CSR就能降低，理想情况下N=0，但是无论如何如果N &gt;= 4，则要好好检查检查。另外网上说的CSR&lt;5000，我认为标准不该如此单一。</p>
<p>这三个指标在 LoadRunner 中可以监控到；另外，在 linux 中，也可以用 vmstat 查看r（Load Arerage），in（Interrupt）和cs（Context Switch）</p>
<h1 id="5-_工具">5. 工具</h1>
<p>uptime</p>
<p>dmesg</p>
<p>top<br>查看进程活动状态以及一些系统状况</p>
<p>vmstat<br>查看系统状态、硬件和系统信息等</p>
<p>iostat<br>查看CPU 负载，硬盘状况</p>
<p>sar<br>综合工具，查看系统状况</p>
<p>mpstat<br>查看多处理器状况</p>
<p>netstat<br>查看网络状况</p>
<p>iptraf<br>实时网络状况监测</p>
<p>tcpdump<br>抓取网络数据包，详细分析</p>
<p>mpstat<br>查看多处理器状况</p>
<p>tcptrace<br>数据包分析工具</p>
<p>netperf<br>网络带宽工具</p>
<p>dstat<br>综合工具，综合了 vmstat, iostat, ifstat, netstat 等多个信息</p>
<h1 id="Reference">Reference</h1>
<p><a href="http://tmq.qq.com/2016/07/it-is-necessary-to-know-the-background-performance-test/" target="_blank" rel="external">http://tmq.qq.com/2016/07/it-is-necessary-to-know-the-background-performance-test/</a><br><a href="https://www.ibm.com/developerworks/java/library/j-nativememory-linux/" target="_blank" rel="external">https://www.ibm.com/developerworks/java/library/j-nativememory-linux/</a><br><a href="http://www.oracle.com/technetwork/java/javase/index-137495.html" target="_blank" rel="external">http://www.oracle.com/technetwork/java/javase/index-137495.html</a><br><a href="http://www.hollischuang.com/archives/303" target="_blank" rel="external">http://www.hollischuang.com/archives/303</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/调试/">调试</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/08/13/服务调优/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/31/Stanford-Machine-Learning-Week-2-Linear-Regression-with-multiple-features/" title="Stanford Machine Learning - Week 2 - Linear Regression with multiple features" itemprop="url">Stanford Machine Learning - Week 2 - Linear Regression with multiple features</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-07-31T05:07:10.000Z" itemprop="datePublished"> Published Jul 31 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="使用_Gradient_descent_求解多变量的线性回归问题">使用 Gradient descent 求解多变量的线性回归问题</h1>
<h2 id="多变量的线性回归">多变量的线性回归</h2>
<p>n: 特征(features) 数量<br>m: 训练集数量<br>$x^{(i)}$: </p>
<ul>
<li>表示一条训练数据的向量</li>
<li>i is an index into the training set</li>
<li>So <ul>
<li>x is an n-dimensional feature vector</li>
<li>$x^{(3)}$ is, for example, the 3rd training data</li>
</ul>
</li>
</ul>
<p>$x^{(j)}_i$: The value of feature j in the ith training example</p>
<p>例如，当 n=4 时:<br>$$h_θ(x) = θ_0 + θ_1x_1 + θ_2x_2 + θ_3x_3 + θ_4x_4$$</p>
<p>For convenience of notation, $x_0$ = 1, 所以最后的特征向量的维度是 n+1，从 0 开始，记为”X”，<br>则有：<br>$$h_θ(x)=θ^TX$$<br>$θ^T$: [1 * (n+1)] matrix</p>
<h2 id="多变量的梯度下降">多变量的梯度下降</h2>
<h3 id="Cost_Function">Cost Function</h3>
<p>$$J(θ_0, θ_1, …,θ_n) =  \frac1{2m}\sum_{i=1}^{m}{(h_θ(x^{(i)}) - y^{(i)})^2}$$</p>
<h3 id="Gradient_descent">Gradient descent</h3>
<p>Repeat {<br>  $$ θ_j = θ_j - α\frac\partial{\partial J(θ_0, θ_1, …,θ_n)} $$<br>}</p>
<p>every iterator</p>
<ul>
<li>θj = θj - learning rate (α) times the partial derivative of J(θ) with respect to θJ(…)</li>
<li>We do this through a simultaneous update of every θj value</li>
</ul>
<p>$$ \frac\partial{\partial J(θ_0, θ_1, …,θ_n)} $$<br>$$ = \frac1m * \sum_{i=1}^{m}{(h_θ(x^{(i)}) - y^{(i)})}*x_j^{(i)} $$</p>
<h2 id="Gradient_Decent_in_practice">Gradient Decent in practice</h2>
<h3 id="Feature_Scaling">Feature Scaling</h3>
<p>假设只有 $x_1$,$x_2$ 两个变量，其中：$x_1\in(0,2000), x_2\in(1,5)$，则最后的 J(θ) 图形是一个椭圆，在椭圆下用梯度下降法会比圆形要耗时更久，So we need to rescale this input so it’s more effective，有很多方式，一种是将各个 feature 除以其本身的最大值，缩小范围至[0,1]，一种是各个 feature 减去 mean 然后除以最大值，缩小范围至[-0.5,0.5]</p>
<h3 id="Learning_Rate_α">Learning Rate α</h3>
<ul>
<li>working correctly: If gradient descent is working then J(θ) should decrease after every iteration</li>
<li>convergence: 收敛是指每经过一次迭代，J(θ)的值都变化甚小。</li>
<li>choose α<ol>
<li>When to use a smaller α<ul>
<li>If J(θ) is increasing, see below picture</li>
<li>If J(θ) looks like a series of waves, decreasing and increasing again</li>
<li>But if α is too small then rate is too slow</li>
</ul>
</li>
<li>Try a range of α values<ul>
<li>Plot J(θ) vs number of iterations for each version of alpha</li>
<li>Go for roughly threefold increases: 0.001, 0.003, 0.01, 0.03. 0.1, 0.3</li>
</ul>
</li>
</ol>
</li>
</ul>
<p><img src="/img/gradient_descent_plot.jpg" alt=""></p>
<h2 id="Features_and_polynomial_regression">Features and polynomial regression</h2>
<h3 id="Can_create_new_features">Can create new features</h3>
<p>如何选择 features 和表达式尤为关键，例如房价与房子的长，房子的宽组成的表达式就会麻烦很多，若将房子的长乘以房子的宽得出面积，则有房价与房子面积的表达式，将会更容易拟合出房价的走势。</p>
<h3 id="Polynomial_regression">Polynomial regression</h3>
<p>例如房价的走势，如下图，横坐标 x 为房子的面积，纵坐标为房价，使用一元二次的方程，会得出下图的蓝色曲线。容易得到房价今后会有一个下降的过程，可实际上房价是不会随着面积的增大而下降的。所以需要重新选定 Polynomial regression，可以改为使用一元三次的方程或者使用平凡根的方程。</p>
<p><strong>所以选择合适的 Features 和 Polynomial regression 都非常重要。</strong></p>
<p><img src="/img/polynomial_regression_choose.jpg" alt=""></p>
<h1 id="使用_Normal_equation_求解多变量的线性回归问题">使用 Normal equation 求解多变量的线性回归问题</h1>
<h2 id="Normal_equation">Normal equation</h2>
<p>举例说明，假设 J(θ) 是一元二次方程，如：J(θ)=a$θ^2$+bθ+c，则令 $$ \frac{d}{dθ}J(θ)=2aθ+b=0$$ 即可，求出最终的 θ 则得到了线性回归方程，可以预测出今后的 y 值。</p>
<p>更普遍地，当 θ 是一个 n+1 维的向量时，θ $\in$ $R^{n+1}$，则 cost function 如下：<br>$$ J(θ_0, θ_1, …,θ_n) =  \frac1{2m}\sum_{i=1}^{m}{(h_θ(x^{(i)}) - y^{(i)})^2} $$<br>只需要令：<br>$$ \frac\partial{\partial θ_j}J(θ_0, θ_1, …,θ_n) = … = 0 $$，其中 j = 0,1,2,…,n<br>设 X 代表训练集的 features 的值的矩阵，y 代表训练集的结果的值的矩阵，假设训练集数量为 m, features 个数为 n, 则 X 为 (m*n) 的矩阵，y 为 (m*1) 的矩阵，可以推导出求 θ 向量的公式如下：<br>$$θ = (X^TX)^{-1}X^Ty$$</p>
<h1 id="Gradient_descent_Vs_Normal_equation">Gradient descent Vs Normal equation</h1>
<h2 id="Gradient_descent-1">Gradient descent</h2>
<ul>
<li>Need to chose learning rate</li>
<li>Needs many iterations - could make it slower</li>
<li>Works well even when n is massive (millions)</li>
<li>Better suited to big data</li>
<li>What is a big n though: 100 or even a 1000 is still (relativity) small, If n is 10000 then look at using gradient descent</li>
<li>适用于线性回归会逻辑回归</li>
</ul>
<h2 id="Normal_equation-1">Normal equation</h2>
<ul>
<li>No need to chose a learning rate</li>
<li>No need to iterate, check for convergence etc.</li>
<li>Normal equation needs to compute $(X^TX)^{-1}$<ul>
<li>This is the inverse of an n x n matrix</li>
<li>With most implementations computing a matrix inverse grows by O(n3), So not great</li>
</ul>
</li>
<li>Slow of n is large, Can be much slower</li>
<li>仅适用于线性回归</li>
</ul>
<h1 id="Reference">Reference</h1>
<blockquote>
<p><a href="http://www.holehouse.org/mlclass/04_Linear_Regression_with_multiple_variables.html" target="_blank" rel="external">http://www.holehouse.org/mlclass/04_Linear_Regression_with_multiple_variables.html</a></p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/机器学习/">机器学习</a><a href="/tags/coursera/">coursera</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/31/Stanford-Machine-Learning-Week-2-Linear-Regression-with-multiple-features/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/30/Stanford Machine Learning-Week 1- Linear Regression with One Variable/" title="Stanford Machine Learning - Week 1 - Linear Regression with One Variable" itemprop="url">Stanford Machine Learning - Week 1 - Linear Regression with One Variable</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-07-30T03:55:04.000Z" itemprop="datePublished"> Published Jul 30 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="线性回归">线性回归</h2>
<p>适用于监督学习，根据已有的数据集合(x, y)，来推断出将来的数据趋势。</p>
<h2 id="只有一个变量的线性回归">只有一个变量的线性回归</h2>
<p>最后的函数应该是 y = ax + b，假设 hypothesis 为：</p>
<p>$h_{\theta}$(x) = $\theta_{0}$ + $\theta_{1}$x</p>
<p>则问题转化为求 $\theta_{0}$ 和 $\theta_{1}$ 的值。要求这两个值需要转化上式，并根据已有的数据来求解。下面介绍损失函数，又叫代价函数的概念。</p>
<h2 id="Cost_Function">Cost Function</h2>
<p>针对每一组数据，公式的值是 $h_{\theta}$($x_{i}$), 实际的值是 $y_{i}$，我们要达到的效果则是公式能够尽量表达已有的 m 组数据集合，即 $( h_{\theta}(x^{(i)}) - y_{i})^{2}$ 的值尽量小。<br>所以，对于所有数据集合，需要求使得<br>$$ \frac1{2m}\sum_{i=1}^{m}{(h_{\theta}(x^{(i)}) - y^{(i)})^2}$$ 最小的 $\theta$ 值。</p>
<p>上式又称为 Cost Function，可以写为：</p>
<p>$$ J(\theta_0, \theta_1) =  \frac1{2m}\sum_{i=1}^{m}{(h_{\theta}(x^{(i)}) - y^{(i)})^2} $$</p>
<p>我们需要最小化这个 Cost Function。</p>
<h2 id="Cost_Function_的作用">Cost Function 的作用</h2>
<p>假设 $\theta_0$ = 0，则有 $\theta_1$ 和 J($\theta_1$) 的关系，且图形如下：<br><img src="/img/cost_function_theta1.jpg" alt=""></p>
<p>所以当 $\theta_1$ = 1 时，<br>$$ J(\theta_1)= \frac1{2m}\sum_{i=1}^{m}{(\theta_1x^{(i)} - y^{(i)})^2} $$<br>很容易看出，$J(\theta_1)$ 是关于 $\theta_1$ 的一元二次方程，对于所有的训练数据，每个 $\theta_1$ 的取值都会得到一个 $J(\theta_1)$ 值，而 $J(\theta_1)$ 和 $\theta_1$ 的对应关系根据一元二次方程可知，函数曲线如上图。<br>当 $J(\theta_1)$ 最小时，求得 $\theta_1$ 结果。</p>
<p>当 $\theta_0$ 和 $\theta_1$ 都不为 0 时，J($\theta_0$, $\theta_1$) 的图形如下：<br><img src="/img/cost_function_theta0_theta1.jpg" alt=""></p>
<p>对于两个系数的情况不如一个系数是一个二维坐标系的抛物线那么简单。下面将介绍梯度下降法。</p>
<h2 id="梯度下降法">梯度下降法</h2>
<ul>
<li>Start with initial guesses</li>
<li>Start at 0,0 (or any other value)</li>
<li>Keeping changing $\theta_0$ and $\theta_1$ a little bit to try and reduce J($\theta_0$, $\theta_1$)</li>
<li>Each time you change the parameters, you select the gradient which reduces J($\theta_0$, $\theta_1$) the most possible </li>
<li>Repeat</li>
<li>Do so until you converge to a local minimum<br>Has an interesting property<ul>
<li>Where you start can determine which minimum you end up</li>
<li>Here we can see one initialization point led to one local minimum</li>
<li>The other led to a different one</li>
</ul>
</li>
</ul>
<p><img src="/img/gradient_descent_progress.jpg" alt=""></p>
<h3 id="具体的计算过程">具体的计算过程</h3>
<p>$$ \theta_j := \theta_j - \alpha \frac\partial{\partial\theta_j}J(\theta_0, \theta_1)$$<br>(for j = 0 and j = 1)</p>
<h4 id="Notation">Notation</h4>
<p><strong>$\alpha$</strong></p>
<ul>
<li>Is a number called the learning rate</li>
<li>Controls how big a step you take<ul>
<li>If α is big have an aggressive gradient descent</li>
<li>If α is small take tiny steps</li>
</ul>
</li>
<li>Too small<ul>
<li>Take baby steps</li>
<li>Takes too long</li>
</ul>
</li>
<li>Too large<ul>
<li>Can overshoot the minimum and fail to converge</li>
</ul>
</li>
</ul>
<h4 id="Computer">Computer</h4>
<p>每次都是<strong>同时</strong>计算 $\theta_0, \theta_1$ 的值，如下：<br>$$ temp0:= \theta_0 - \alpha \frac\partial{\partial\theta_0}J(\theta_0, \theta_1)$$<br>$$ temp1:= \theta_1 - \alpha \frac\partial{\partial\theta_1}J(\theta_0, \theta_1)$$<br>$$ \theta_0 := temp0 $$<br>$$ \theta_1 := temp1 $$</p>
<p><img src="/img/gradient_descent_demo.jpg" alt=""></p>
<h2 id="利用梯度下降法求解线性回归问题">利用梯度下降法求解线性回归问题</h2>
<!-- $$
\begin{aligned}
& \frac\partial{\partial\theta\_j}J(\theta\_0, \theta\_1) \\
& = \frac\partial{\partial\theta\_j} * \frac1{2m}\sum\_{i=1}^{m}{(h\_{\theta}(x^{(i)}) - y^{(i)})^2} \\
& = \frac\partial{\partial\theta\_j} * \frac1{2m}\sum\_{i=1}^{m}{(\theta\_0 +\theta\_1x^{(i)} - y^{(i)})^2} \\
\end{aligned}
$$ -->


<p>$$ \frac\partial{\partial\theta_j}J(\theta_0, \theta_1) $$</p>
<p>$$ =\frac\partial{\partial\theta_j} * \frac1{2m}\sum_{i=1}^{m}{(h_{\theta}(x^{(i)}) - y^{(i)})^2} $$</p>
<p>$$ =\frac\partial{\partial\theta_j} * \frac1{2m}\sum_{i=1}^{m}{(\theta_0 +\theta_1x^{(i)} - y^{(i)})^2} $$</p>
<p>对于 j = 0 or 1 的情况有：<br>j = 0:<br>$$ \frac\partial{\partial\theta_0}J(\theta_0, \theta_1) = \frac1{m}\sum_{i=1}^{m}(h_{\theta}(x^{(i)}) - y^{(i)})$$<br>j = 1:<br>$$ \frac\partial{\partial\theta_1}J(\theta_0, \theta_1) = \frac1{m}\sum_{i=1}^{m}(h_{\theta}(x^{(i)}) - y^{(i)})*x^{(i)}$$</p>
<h2 id="梯度下降法的证明">梯度下降法的证明</h2>
<p>1、如果优化函数存在解析解。例如我们求最值一般是对优化函数求导，找到导数为0的点。如果代价函数能简单求导，并且求导后为0的式子存在解析解，那么我们就可以直接得到最优的参数。</p>
<p>2、如果式子很难求导，例如函数里面存在隐含的变量或者变量相互间存在耦合，互相依赖的情况。或者求导后式子得不到解释解，或者未知参数的个数大于方程组的个数等。这时候使用迭代算法来一步一步找到最优解。</p>
<ul>
<li>当目标函数是凸函数时，梯度下降法的解是全局最优解</li>
<li>一般情况下，其解不保证是全局最优解</li>
</ul>
<h3 id="凸函数">凸函数</h3>
<p>凸函数就是一个定义在某个向量空间的凸子集C（区间）上的实值函数 f，而且对于凸子集C中任意两个向量 $x_1$, $x_2$ 有：<br>$$f(\frac{x_1+x_2}{2}) \le \frac{f(x_1)+f(x_2)}{2}$$<br>于是容易得出对于任意（0,1)中有理数 p，有：<br>$$f(px_1+(1-p)x_2) \le pf(x_1)+(1-p)f(x_2)$$<br>如果 f 连续，那么 p 可以改成任意（0,1）中实数。则 f 称为 I 上的凸函数，当且仅当其上境图（在函数图像上方的点集）为一个凸集。</p>
<h2 id="梯度下降法的使用">梯度下降法的使用</h2>
<p>我们首先在函数上任选一点，计算其损失（即我们上面的L(w)） ，然后按照某一规则寻找更低的一点计算新的损失，只要新损失更小（最小化问题），我们就继续下降，直到达到一个可接受的优化目标。<br>梯度下降方法分为两个部分，第一部分是整体上，我们使用某步长不断下降求损失函数，第二部分是为了防止步长太长导致最后无法收敛，每次当损失上升的时候都调整步长。<br>通常实践中使用时，都是用一些开源算法，很少需要深度改进，比如使用 libsvm 可以直接求解逻辑回归。</p>
<h1 id="Reference">Reference</h1>
<blockquote>
<p><a href="http://www.cnblogs.com/yysblog/p/3268508.html" target="_blank" rel="external">http://www.cnblogs.com/yysblog/p/3268508.html</a><br><a href="http://52opencourse.com/125/coursera%E5%85%AC%E5%BC%80%E8%AF%BE%E7%AC%94%E8%AE%B0-%E6%96%AF%E5%9D%A6%E7%A6%8F%E5%A4%A7%E5%AD%A6%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%AC%E5%85%AD%E8%AF%BE-%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-logistic-regression" target="_blank" rel="external">http://52opencourse.com/125/coursera%E5%85%AC%E5%BC%80%E8%AF%BE%E7%AC%94%E8%AE%B0-%E6%96%AF%E5%9D%A6%E7%A6%8F%E5%A4%A7%E5%AD%A6%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%AC%E5%85%AD%E8%AF%BE-%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-logistic-regression</a><br><a href="http://www.cnblogs.com/chaoren399/p/4851658.html" target="_blank" rel="external">http://www.cnblogs.com/chaoren399/p/4851658.html</a></p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/机器学习/">机器学习</a><a href="/tags/coursera/">coursera</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/07/30/Stanford Machine Learning-Week 1- Linear Regression with One Variable/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/22/使用-HBase-总结/" title="使用 HBase 总结" itemprop="url">使用 HBase 总结</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-05-22T08:27:28.000Z" itemprop="datePublished"> Published May 22 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="1-_HBase_简介">1. HBase 简介</h1>
<p>HBase是Apache Hadoop的数据库，基于列存储、构建在HDFS上的分布式存储系统，能够对大型数据提供随机、实时的读写访问，是Google的BigTable的开源实现。HBase的目标是存储并处理大型的数据，仅用普通的硬件配置，就能够处理海量数据。</p>
<h2 id="1-1_HBase_的优点">1.1 HBase 的优点</h2>
<ol>
<li>高可扩展性<br>HBase 是真正意义上的线性水平扩展。数据量累计到一定程度(可配置)，HBase系统会自动对数据进行水平切分，并分配不同的服务器来管理这些数据。这些数据可以被扩散到上千个普通服务器上。这样一方面可以由大量普通服务器组成大规模集群，来存放海量数据(从几个 TB 到几十 PB 的数据)。另一方面，当数据峰值接近系统设计容量时，可以简单通过增加服务器的方式来扩大容量。这个动态扩容过程无需停机，HBase系统可以照常运行并提供读写服务，完全实现动态无缝无宕机扩容。</li>
<li>高性能<br>HBase 的设计目的之一是支持高并发用户数的高速读写访问。这是通过两方面来实现的。首先数据行被水平切分并分布到多台服务器上，在大量用户访问时，访问请求也被分散到了不同的服务器上，虽然每个服务器的服务能力有限，但是数千台服务器汇总后可以提供极高性能的访问能力。其次，HBase 设计了高效的缓存机制，有效提高了访问的命中率，提高了访问性能。</li>
<li>高可用性<br>HBase 建立在 HDFS 之上。HDFS 提供了数据自动复制和容错的功能。HBase 的日志和数据都存放在 HDFS 上，即使在读写过程中当前服务器出现故障(硬盘、内存、网络等故障)，日志也不会丢失，数据都可以从日志中自动恢复。HBase 系统会自动分配其他服务器接管并恢复这些数据。因此一旦成功写入数据，这些数据就保证被持久化并被冗余复制，整个系统的高可用性得到保证。</li>
</ol>
<h2 id="1-2_数据模型">1.2 数据模型</h2>
<ol>
<li><p>表</p>
<ul>
<li>数据量：一张表可以有数十亿行，上百万列。</li>
<li>最大版本数：通常是3，如果对于更新比较频繁的应用完全可以设置为1，能够快速的淘汰无用数据，对于节省存储空间和提高查询速度有效果。不过这类需求在海量数据领域比较小众。</li>
<li>压缩算法：可以尝试一下最新出炉的snappy算法，相对lzo来说，压缩率接近，压缩效率稍高，解压效率高很多。</li>
<li>inmemory：表在内存中存放，一直会被忽略的属性。如果完全将数据存放在内存中，那么hbase和现在流行的内存数据库memorycached和redis性能差距有多少，尚待实测。</li>
<li>bloomfilter：根据应用来定，看需要精确到rowkey还是column。不过这里需要理解一下原理，bloomfilter的作用是对一个region下查找记录所在的hfile有用。即如果一个region下的hfile数量很多，bloomfilter的作用越明显。适合那种compaction赶不上flush速度的应用。</li>
</ul>
</li>
<li><p>无模式<br>每行都有一个可排序的主键和任意多的列，列可以根据需要动态的增加，同一张表中不同的行可以有截然不同的列；</p>
</li>
<li>面向列<br>面向列（族）的存储和权限控制，列（族）独立检索；</li>
<li>稀疏<br>对于空（null）的列，并不占用存储空间，表可以设计的非常稀疏；</li>
<li>数据多版本<br>每个单元中的数据可以有多个版本，默认情况下版本号自动分配，是单元格插入时的时间戳；</li>
<li>数据类型单一<br>HBase中的数据都是字符串，没有类型。</li>
<li>存储单元 Cell<br>由{rowkey, colomnFamily:colomnQualifier, version} 确定的唯一单元，存储的数据是byte[]类型的。</li>
</ol>
<h1 id="2-_HBase_的设计与实现">2. HBase 的设计与实现</h1>
<h2 id="2-1_HBase_的架构">2.1 HBase 的架构</h2>
<p><img src="/img/HBase_ architecture.jpg" alt=""><br>由上图可知，hbase包括Clinet、HMaster、HRegionServer、ZooKeeper组件<br>各组件功能介绍：</p>
<ol>
<li>Client<br>Client主要通过ZooKeeper与Hbaser和HRegionServer通信，对于管理操作：client向master发起请求，对于数据读写操作：client向regionserver发起请求</li>
<li>ZooKeeper<br>zk负责存储<em>root</em>表的地址，也负责存储当前服务的master地址,regsion server也会将自身的信息注册到zk中，以便master能够感知region server的状态，zk也会协调active master，也就是可以提供一个选举master leader,也会协调各个region server的容灾流程</li>
<li>HMaster<br>master可以启动多个master，master主要负责table和region的管理工作，响应用户对表的CRUD操作，管理region server的负载均衡，调整region 的分布和分配，当region server停机后，负责对失效的regionn进行迁移操作</li>
<li>HRegionServer<br>region server主要负责响应用户的IO请求，并把IO请求转换为读写HDFS的操作</li>
</ol>
<h2 id="2-2_HBase_的架构详解">2.2 HBase 的架构详解</h2>
<p><a href="https://www.mapr.com/blog/in-depth-look-hbase-architecture#.VdMxvWSqqko" target="_blank" rel="external">https://www.mapr.com/blog/in-depth-look-hbase-architecture#.VdMxvWSqqko</a></p>
<h1 id="3-_HBase,_Mysql_的比较">3. HBase, Mysql 的比较</h1>
<p>Mysql 是关系型数据库，对于数据量不大(百万级别)，强依赖事务的业务，使用Mysql。<br>HBase 适用于对大数据进行随机、实时访问的场合，支持海量数据，扩展性好。<br>HBase 不适用的场景：</p>
<ul>
<li>对分布式事务支持的不好</li>
<li>不支持多表的联合查询</li>
<li>对于复杂查询，需要扫描全表，且不支持索引</li>
</ul>
<h1 id="4-_设计_HBase_表">4. 设计 HBase 表</h1>
<h2 id="4-1_RowKey_的设计">4.1 RowKey 的设计</h2>
<p>Rowkey唯一原则，必须在设计上保证其唯一性。但是还有几点需要注意的地方：</p>
<h3 id="4-1-1_RowKey_长度的设计">4.1.1 RowKey 长度的设计</h3>
<p>Rowkey是一个二进制码流，可以是任意字符串，最大长度64KB，实际应用中一般为10~100bytes，存为byte[]字节数组。</p>
<ol>
<li>定长<br>定长的好处是 RowKey 排序时是按字典序且不受不同长度的影响</li>
<li>短<br>不要超过16个字节。<ul>
<li>数据的持久化文件 HFile 是按照 KeyValue 存储的，如果 Rowkey 过长比如100个字节，1000万列数据光 Rowkey 就要占用100*1000万=10亿个字节，将近1G数据，这会极大影响 HFile 的存储效率；</li>
<li>MemStore 将缓存部分数据到内存，如果 Rowkey 字段过长内存的有效利用率会降低，系统将无法缓存更多的数据，这会降低检索效率。</li>
</ul>
</li>
<li>16个字节<br>目前操作系统是都是64位系统，内存8字节对齐。控制在16个字节，8字节的整数倍利用操作系统的最佳特性。</li>
</ol>
<h3 id="4-1-2_RowKey_含义的设计">4.1.2 RowKey 含义的设计</h3>
<p>RowKey 虽然是越短越好，但也需要考虑 RowKey 的含义。由于 HBase 是按字典序存储，所以 RowKey 设计的合理可以提高查询效率(因为这会提高 RegionServer 的缓存命中率)，并且有意义的 RowKey 也便于在 scan 表的时候确定 startRow 和 stopRow。</p>
<ol>
<li>RowKey 包含时间<br>不要将时间放在二进制码的前面，建议将 RowKey 的高位作为散列字段（或者本身就已经是散列的其他id，例如userId），低位放时间字段。否则最新的数据都集中放在某个 RegionServer，而访问量又都集中在最新的数据上，将会导致 Hotspotting 现象，降低了访问速度，同时也增加了 RegionServer Crash 的概率。<br>但考虑到是按字典序存储，如果想让最新的数据在最前面，可以使用 Long.MAX_VALUE – timestamp 作为 RowKey 的一部分。</li>
<li>RowKey 包含多个含义时<br>各个含义用某种分隔符分开，比如包含用户，类型，时间三种含义的 RowKey, 可以设计为 userId#type#timestamp，这样如果需要查找某个用户某段时间的数据，scan 时只需要根据 userId 设置 startRow 和 stopRow 即可。</li>
</ol>
<h3 id="4-1-3_RowKey_性能的设计">4.1.3 RowKey 性能的设计</h3>
<p>RowKey 是按照字典序存储，利用这个排序特点，将经常一起读取或者最近可能被访问到的数据存储到一块可以提高查询效率。</p>
<ol>
<li>Hotspotting<br>It is always advisable not to use sequential row keys, even though you get better scan results. More info here.<br>Salting Row Key. To prevent hot spotting on writes, the row key may be “salted” by inserting a leading byte into the row key which is a mod over N buckets of the hash of the entire row key. This ensures even distribution of writes when the row key is a monotonically increasing value (often a timestamp representing the current time).</li>
<li>Length of row key<br>For each cell, rowkey details, column family, and qualifier details are stored. So it is always advisable to keep them as shot as possible, mainly because the same information is repeated on large scale.</li>
<li>So whats next<br>salt usage and its prefixing will help to distribute the rows among region servers.This can help you.</li>
</ol>
<h2 id="4-2_ColumnFamily_的设计">4.2 ColumnFamily 的设计</h2>
<h3 id="4-2-1_ColumnFamily_的长度">4.2.1 ColumnFamily 的长度</h3>
<p>The column family and column qualifier names are repeated for each row. Therefore, keep the names as short as possible to reduce the amount of data that HBase stores and reads. For example, use f:q instead of mycolumnfamily:mycolumnqualifier.</p>
<h3 id="4-2-2_ColumnFamily_的数量">4.2.2 ColumnFamily 的数量</h3>
<p>On the number of column families<br>HBase currently does not do well with anything above two or three column families so keep the number of column families in your schema low. Currently, flushing and compactions are done on a per Region basis so if one column family is carrying the bulk of the data bringing on flushes, the adjacent families will also be flushed though the amount of data they carry is small. When many column families the flushing and compaction interaction can make for a bunch of needless i/o loading (To be addressed by changing flushing and compaction to work on a per column family basis). For more information on compactions, see compaction. (具体的细节见第2节)</p>
<p>Try to make do with one column family if you can in your schemas. Only introduce a second and third column family in the case where data access is usually column scoped; i.e. you query one column family or the other but usually not both at the one time.</p>
<p>Where multiple ColumnFamilies exist in a single table, be aware of the cardinality (i.e., number of rows). If ColumnFamilyA has 1 million rows and ColumnFamilyB has 1 billion rows, ColumnFamilyA’s data will likely be spread across many, many regions (and RegionServers). This makes mass scans for ColumnFamilyA less efficient.</p>
<p>建议HBASE列族的数量设置的越少越好。由于HBASE的FLUSHING和压缩是基于REGION的当一个列族所存储的数据达到FLUSHING阀值时，该表的所有列族将同时进行FLASHING操作，这将带来不必要的I/O开销。同时还要考虑到同一个表中不同列族所存储的记录数量的差别，即列族的势。当列族数量差别过大将会使包含记录数量较少的列族的数据分散在多个Region之上，而Region可能是分布是不同的RegionServer上。这样当进行查询等操作系统的效率会受到一定影响。</p>
<h2 id="4-3_Column_的设计">4.3 Column 的设计</h2>
<h3 id="4-3-1_Column_的长度">4.3.1 Column 的长度</h3>
<p>The column family and column qualifier names are repeated for each row. Therefore, keep the names as short as possible to reduce the amount of data that HBase stores and reads. For example, use f:q instead of mycolumnfamily:mycolumnqualifier.</p>
<h3 id="4-3-2_Column_的数量">4.3.2 Column 的数量</h3>
<p>Column mapping: one to many<br>You can map a single HBase entity (row key or a column) to multiple SQL columns. This kind of mapping is called one to many. HBase stores a lot of information for each value. If you stored each SQL column individually, the required storage space would be very large. For the best performance, put columns that are queried together into a single dense HBase column to help reduce the data that is fetched from HBase. A dense column is a single HBase column that maps to multiple SQL columns.</p>
<p>For example, if table T1 has nine columns with 1.5 million rows. and you use a one-to-one mapping, this table requires 522 MB of storage. However, if table T1 uses a one-to-many mapping, the table requires only 276 MB of storage.</p>
<h1 id="5-_读_HBase_的性能">5. 读 HBase 的性能</h1>
<h2 id="5-1_HBase_Pool">5.1 HBase Pool</h2>
<p>Use pool of workers to parallel requests. You may find useful HTablePool class for managing connections in workers.</p>
<h2 id="5-2_批量读">5.2 批量读</h2>
<p>通过调用 HTable.get(Get) 方法可以根据一个指定的 RowKey 获取一行记录，同样 HBase 提供了另一个方法：通过调用 HTable.get(List<get>) 方法可以根据一个指定的 RowKey 列表，批量获取多行记录，这样做的好处是批量执行，只需要一次网络I/O开销，这对于对数据实时性要求高而且网络传输RTT高的情景下可能带来明显的性能提升。</get></p>
<h2 id="5-3_Scan">5.3 Scan</h2>
<ol>
<li>Scanner Caching<br>hbase.client.scanner.caching配置项可以设置HBase scanner一次从服务端抓取的数据条数，默认情况下一次一条。通过将其设置成一个合理的值，可以减少scan过程中next()的时间开销，代价是 scanner需要通过客户端的内存来维持这些被cache的行记录。</li>
<li>Scan AttributeSelection<br>scan时指定需要的Column Family，可以减少网络传输数据量，否则默认scan操作会返回整行所有Column Family的数据。</li>
<li>Close ResultScanner<br>通过scan取完数据后，记得要关闭ResultScanner，否则RegionServer可能会出现问题（对应的Server资源无法释放）。</li>
</ol>
<h2 id="5-4_PrefixFilter">5.4 PrefixFilter</h2>
<h3 id="5-4-1_PefixFilter_Vs_Scan">5.4.1 PefixFilter Vs Scan</h3>
<ul>
<li>HBase filters - even row filters - are really slow, since in most cases these do a complete table scan, and then filter on those results. </li>
<li>Row key range scans however, are indeed much faster - they do the equivalent of a filtered table scan. This is because the row keys are stored in sorted order (this is one of the basic guarantees of HBase, which is a BigTable-like solution), so the range scans on row keys are very fast.</li>
</ul>
<h3 id="5-4-2_Convert_PrefixFilter_to_Scan">5.4.2 Convert PrefixFilter to Scan</h3>
<p>PrefixFilter: abc<br>Scan ‘mytable’, {STARTROW =&gt; ‘abc’, ENDROW =&gt; ‘abd’}</p>
<h1 id="6-_如何解决事务">6. 如何解决事务</h1>
<ol>
<li>transactions over hbase<br>The way HBase works is that locks are held in the regionserver (not in the client) when the Puts are applied to make sure that rows are written in an atomic block but it does not provide snapshot isolation (you need to use something like omid if you want that).</li>
</ol>
<p>Since HBase does not guarantee any consistency between regions (and each region is hosted at exactly one RegionServer) all MVCC data structures only need to be kept in memory on every region server.</p>
<p>I would probably not use HBase for a use case like this. but if you must you can lock the row, read, update if needed - read more about lock and some of its problems here ngdata.com/hbase-row-locks . Again, I’d try to rethink the scenario for instance, HBase support multiple version so you can update anyway and sort things later (e.g. in a coprocessor that runs after update)<br>RowLock and associated operations are deprecated in 0.94 and removed in 0.96.issues.apache.org/jira/browse/HBASE-7315 – Matt Ball</p>
<ol>
<li>hbase checkAndPut<br>hbase checkandput performance<br>When you use checkAndPut() you do one RPC-call per request. So, you can’t achieve performance more then 1 / rtt requests per second (rtt is Round Trip Time). If you have rtt 1ms between your client and region server, your theoretical maximum is 1000 rps. When using batch operations like put(List<put>) you need a lot less RPC-calls causing performance increase.</put></li>
</ol>
<h1 id="Reference">Reference</h1>
<blockquote>
<p><a href="http://blog.linezing.com/2012/03/hbase-performance-optimization/" target="_blank" rel="external">http://blog.linezing.com/2012/03/hbase-performance-optimization/</a><br><a href="https://www.ibm.com/support/knowledgecenter/SSPT3X_2.1.2/com.ibm.swg.im.infosphere.biginsights.analyze.doc/doc/bigsql_designhints.html" target="_blank" rel="external">https://www.ibm.com/support/knowledgecenter/SSPT3X_2.1.2/com.ibm.swg.im.infosphere.biginsights.analyze.doc/doc/bigsql_designhints.html</a><br><a href="http://blog.kissdata.com/2014/07/30/hbase-scheme-tips.html" target="_blank" rel="external">http://blog.kissdata.com/2014/07/30/hbase-scheme-tips.html</a><br><a href="http://blog.chedushi.com/archives/9720" target="_blank" rel="external">http://blog.chedushi.com/archives/9720</a><br><a href="https://www.mapr.com/blog/in-depth-look-hbase-architecture#.VdMxvWSqqko" target="_blank" rel="external">https://www.mapr.com/blog/in-depth-look-hbase-architecture#.VdMxvWSqqko</a><br><a href="https://cloud.google.com/bigtable/docs/schema-design" target="_blank" rel="external">https://cloud.google.com/bigtable/docs/schema-design</a><br><a href="http://www.slideshare.net/alexbaranau/transactions-over-hbase" target="_blank" rel="external">http://www.slideshare.net/alexbaranau/transactions-over-hbase</a><br><a href="https://hbase.apache.org/acid-semantics.html" target="_blank" rel="external">https://hbase.apache.org/acid-semantics.html</a></p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/分布式/">分布式</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/05/22/使用-HBase-总结/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/17/https详解/" title="https详解" itemprop="url">https详解</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-04-17T13:55:14.000Z" itemprop="datePublished"> Published Apr 17 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="什么是https">什么是https</h1>
<p>也称作HTTP over TLS</p>
<h1 id="什么是SSL/TLS">什么是SSL/TLS</h1>
<p>1994年，NetScape公司设计了SSL协议（Secure Sockets Layer）的1.0版，但是未发布。<br>1995年，NetScape公司发布SSL 2.0版，很快发现有严重漏洞。<br>1996年，SSL 3.0版问世，得到大规模应用。<br>1999年，互联网标准化组织ISOC接替NetScape公司，发布了SSL的升级版TLS 1.0版。<br>2006年和2008年，TLS进行了两次升级，分别为TLS 1.1版和TLS 1.2版。最新的变动是2011年TLS 1.2的修订版。<br>TLS 1.0通常被标示为SSL 3.1，TLS 1.1为SSL 3.2，TLS 1.2为SSL 3.3。</p>
<h1 id="为什么要有https">为什么要有https</h1>
<p>在说HTTPS之前先说说什么是HTTP，HTTP就是我们平时浏览网页时候使用的一种协议。HTTP协议传输的数据都是未加密的，也就是明文的，因此使用HTTP协议传输隐私信息非常不安全。为了保证这些隐私数据能加密传输，于是网景公司设计了SSL（Secure Sockets Layer）协议用于对HTTP协议传输的数据进行加密，从而就诞生了HTTPS。</p>
<h1 id="https保证安全的原理">https保证安全的原理</h1>
<p>Client端和Server端如果用非对称加密的算法进行通信肯定是绝对安全的，因为私钥和密钥没有第三方知道。但是这样的问题是性能低下。但是如果用对称加密，很容易泄露密钥，安全性得不到保证。那么https是如何做的呢？<br>大概原理就是使用非对称加密来交换一个密钥来进行对称加密。这个过程被称为SSL/TSL的四次握手，具体过程如下：</p>
<ol>
<li>Client端向Server端的443端口发出请求，带上随机数client_random和支持的加密方式列表</li>
<li>Server端返回随机数server_random ，选择的加密方式和服务器证书链</li>
<li>Client端验证这个证书是否合法，如果非法则提示用户是否“继续接受这个不可信的网站”，如果合法则使用证书中的公钥加密premaster secret发送给服务端</li>
<li>Server端使用私钥解密premaster secret，然后通过client_random，server_random 和premaster secret 生成master secret，用于对称加密后续通信内容。</li>
<li>Sever端用master secret加密最终需要返回的网站内容</li>
<li>Client端也用相同的方式生成这个master secret解密收到的消息</li>
</ol>
<p>master_secret = PRF(pre_master_secret, “master secret”, ClientHello.random + ServerHello.random)[0..47];</p>
<p><strong>随机数为什么要三个？</strong><br>这是由于SSL/TLS设计，就假设服务器不相信所有的客户端都能够提供完全随机数，假如某个客户端提供的随机数不随机的话，就大大增加了“对话密钥”被破解的风险，所以由三组随机数组成最后的随机数，保证了随机数的随机性，以此来保证每次生成的“对话密钥”安全性。</p>
<p><strong>那么问题来了</strong></p>
<ol>
<li>证书的安全性，Client端是如何验证证书合法性的，这个证书第三方无论如何都伪造不了吗？</li>
<li>对称加密密钥的安全性，生成的master secret密钥第三方为什么拿不到？</li>
</ol>
<p>要解答这两个问题，首先得弄清楚什么是证书。</p>
<h1 id="为什么证书是安全的？">为什么证书是安全的？</h1>
<h2 id="什么是证书">什么是证书</h2>
<p>数字证书就是互联网通讯中标志通讯各方身份信息的一串数字，提供了一种在Internet上验证通信实体身份的方式，数字证书不是数字身份证，而是身份认证机构盖在数字身份证上的一个章或印（或者说加在数字身份证上的一个签名）。它是由权威机构——<strong>CA机构，又称为证书授权（Certificate Authority）</strong>中心发行的，人们可以在网上用它来识别对方的身份。<br>数字证书的格式普遍采用的是X.509V3国际标准，一个标准的X.509数字证书包含以下一些内容：</p>
<ul>
<li>证书的版本信息；</li>
<li>证书的序列号，每个证书都有一个唯一的证书序列号；</li>
<li>证书所使用的签名算法；</li>
<li>证书的发行机构名称，命名规则一般采用X.500格式；</li>
<li>证书的有效期，通用的证书一般采用UTC时间格式，它的计时范围为1950-2049；</li>
<li>证书所有人的名称，命名规则一般采用X.500格式；</li>
<li>证书所有人的公开密钥；</li>
<li>证书发行者对证书的签名。</li>
</ul>
<p>证书里的公钥的作用？<br>证书里的签名的作用？<br>数字证书的签发机构CA，在接收到申请者的资料后进行核对并确定信息的真实有效，然后就会制作一份符合X.509标准的文件。证书中的证书内容包含的持有者信息和公钥等都是由申请者提供的，而数字签名则是CA机构对证书内容进行hash加密后得到的，而这个数字签名就是我们验证证书是否是有可信CA签发的数据。<br><img src="/img/CA.png" alt=""></p>
<h2 id="证书的产生">证书的产生</h2>
<p><img src="/img/certification_production.png" alt=""></p>
<h2 id="证书的类型">证书的类型</h2>
<p>实际上，我们使用的证书分很多种类型，SSL证书只是其中的一种。证书的格式是由X.509标准定义。SSL证书负责传输公钥，是一种PKI（Public Key Infrastructure，公钥基础结构）证书。<br>我们常见的证书根据用途不同大致有以下几种：<br>1、SSL证书，用于加密HTTP协议，也就是HTTPS。<br>2、代码签名证书，用于签名二进制文件，比如Windows内核驱动，Firefox插件，Java代码签名等等。<br>3、客户端证书，用于加密邮件。<br>4、双因素证书，网银专业版使用的USB Key里面用的就是这种类型的证书。<br>这些证书都是由受认证的证书颁发机构——我们称之为CA（Certificate Authority）机构来颁发，针对企业与个人的不同，可申请的证书的类型也不同，价格也不同。CA机构颁发的证书都是受信任的证书，对于SSL证书来说，如果访问的网站与证书绑定的网站一致就可以通过浏览器的验证而不会提示错误。</p>
<h2 id="证书的安全问题">证书的安全问题</h2>
<p><strong>如果让证书安全，那么就需要让客户端拿到的证书是真正想要的证书，即不能让证书被冒充或者被篡改。</strong><br>那么如何保证这一点呢？</p>
<ol>
<li>如果证书自己有一个id</li>
<li>证书的这个id无法被伪造</li>
<li>客户端知道自己想要的证书id是多少</li>
</ol>
<p>如果做到了这三点就能保证证书的安全性了。上面说提到的id就是证书的数字签名。那么什么是数字签名？</p>
<h3 id="数字签名（digital_signature）">数字签名（digital signature）</h3>
<p>数字签名是证书的防伪标签，是将待签名内容通过哈希和私钥加密处理后生成的。目前使用最广泛的 SHA-RSA 数字签名的制作和验证过程如下：</p>
<ol>
<li>数字签名的签发。首先是使用哈希函数对待签名内容进行安全哈希，生成数字摘要，然后使用CA自己的私钥对数字摘要进行加密。</li>
<li>数字签名的校验。使用CA的公钥解密签名，然后使用相同的签名函数对待签名证书内容进行签名并和服务端数字签名里的签名内容进行比较，如果相同就认为校验成功。</li>
</ol>
<p>签发：待签名内容 -&gt; 哈希 -&gt; 数字摘要 -&gt; CA私钥加密 -&gt; 数字签名<br>校验：</p>
<ul>
<li>数字签名 -&gt; CA公钥解密 -&gt; 数字摘要1</li>
<li>待签名内容 -&gt; 哈希 -&gt; 数字摘要2</li>
<li>比较「数字摘要1」和「数字摘要2」是否相等<br><img src="/img/CerValiate.png" alt=""></li>
</ul>
<p>这里有几点需要说明：</p>
<ul>
<li>数字签名签发和校验使用的密钥对是 CA 自己的公私密钥，跟证书申请者提交的公钥没有关系。</li>
<li>数字签名的签发过程跟公钥加密的过程刚好相反，即是用私钥加密，公钥解密。</li>
<li>现在大的 CA 都会有证书链，证书链的好处一是安全，保持根 CA 的私钥离线使用。第二个好处是方便部署和撤销，即如果证书出现问题，只需要撤销相应级别的证书，根证书依然安全。</li>
<li>根 CA 证书都是自签名，即用自己的公钥和私钥完成了签名的制作和验证。而证书链上的证书签名都是使用上一级证书的密钥对完成签名和验证的。</li>
</ul>
<p><strong>那么问题又来了。</strong><br>CA的私钥和公钥是安全的吗？可以被冒充吗？</p>
<h3 id="CA的安全性">CA的安全性</h3>
<p>从根CA开始到直接给客户发放证书的各层次CA，都有其自身的密钥对。CA中心的密钥对一般由硬件加密服务器在机器内直接产生，并存储于加密硬件内，或以一定的加密形式存放于密钥数据库内。加密备份于IC卡或其他存储介质中，并以高等级的物理安全措施保护起来。密钥的销毁要以安全的密钥冲写标准，彻底清除原有的密钥痕迹。需要强调的是，根CA密钥的安全性至关重要，它的泄露意味着整个公钥信任体系的崩溃，所以CA的密钥保护必须按照最高安全级 的保护方式来进行设置和管理。</p>
<p>CA的私钥是自己靠上述方法保管的，不对外公开。<br>CA的公钥是厂商跟浏览器和操作系统合作，把公钥默认装到浏览器或者操作系统环境里。比如firefox 就自己维护了一个可信任的 CA 列表，而chrome 和 IE 使用的是操作系统的 CA 列表。</p>
<h2 id="证书验证失败的原因">证书验证失败的原因</h2>
<p>1、SSL证书不是由受信任的CA机构颁发的(注意这种情况并不一定说明有SSL劫持发生)<br>2、证书过期<br>3、访问的网站域名与证书绑定的域名不一致</p>
<p>至此，可以知道证书在一定程度上是非常安全的，客户端只要收到的证书是合法的，就能很大程度上保证整个会话是安全的。</p>
<h1 id="客户端具体是如何验证SSL证书的">客户端具体是如何验证SSL证书的</h1>
<p>为了抵御这种中间人攻击，SSL证书需要由可信的SSL证书颁发机构颁发，形成一个证书链（比如Gmail的证书链为：最底层为网域 mail.google.com，上一层为Thawte SGC CA证书颁发机构，最顶层为很有名的VeriSign证书颁发机构）。那么，浏览器除了需要验证域和有效期外，还要检查证书链中的上级证书公钥是否有效，上级的上级证书公钥是否有效，直至根证书公钥为止。这样就可以有效避免中间人攻击了，因为根证书公钥都是预装在操作系统中的，黑客如果不是暴力破解，无法得到根证书的私钥。如果黑客自己生成一个私钥，浏览器验证根证书公钥的时候发现无法通过操作系统中预装的公钥加密数据后使用这个私钥进行解密，从而判定这个公钥是无效的。这个方案也是现在https通讯通常的方案。</p>
<p>那么，这个现在所有的浏览器正在使用的https通讯方案就无懈可击了吗？答案仍是否定的。我们可以看到，在后一个方案中，https的安全性需要在证书颁发机构公信力的强有力保障前提下才能发挥作用。如果证书颁发机构在没有验证黑客为mail.google.com的持游者的情况下，给黑客颁发了网域为mail.google.com的证书，那么黑客的中间人攻击又可以顺利实施然而，不验证域名持有者就颁发证书的情况在国外几乎不会发生，但是在国内就不一定了。针对破解目标，国内证书颁发机构WoSign（在此只是举例国内比较有名的证书颁发机构WoSign，并不代表WoSign今后一定会这么做）很有可能为了上级要求颁发了证书给非域名持有者的黑客，从而使得破解目标的Gmail密码被黑客截取。</p>
<h1 id="涉及到的算法">涉及到的算法</h1>
<p>非对称加密算法：RSA，DSA/DSS<br>对称加密算法：AES，RC4，3DES<br>HASH算法：MD5，SHA1，SHA256</p>
<h1 id="总结">总结</h1>
<p>整个过程是递进的，一步一步了解https安全的原理。</p>
<ol>
<li>https如何保证安全又高效？<br>https使用非对称加密算法来交换对称加密的密钥，最后使用对称加密算法来进行通信。</li>
<li>如何保证非对称加密时的安全性？<br>服务端发送证书来传递非对称加密的公钥。保证了公钥和私钥的保密性。</li>
<li>客户端怎么知道证书是不是真的？<br>客户端根据CA证书的公钥校验证书的数字签名来保证其合法性。</li>
<li>客户端的CA证书不会被伪造或泄露吗？<br>CA证书是默认预装到浏览器和操作系统中的，所以CA证书的公钥是安全的。</li>
</ol>
<h1 id="Reference">Reference</h1>
<blockquote>
<p><a href="http://op.baidu.com/2015/04/https-s01a01/" target="_blank" rel="external">http://op.baidu.com/2015/04/https-s01a01/</a><br><a href="https://cipherstuff.wordpress.com/" target="_blank" rel="external">https://cipherstuff.wordpress.com/</a><br><a href="http://oncenote.com/2014/10/21/Security-1-HTTPS/" target="_blank" rel="external">http://oncenote.com/2014/10/21/Security-1-HTTPS/</a><br><a href="http://www.williamlong.info/archives/2058.html" target="_blank" rel="external">http://www.williamlong.info/archives/2058.html</a><br><a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html</a></p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/网络/">网络</a><a href="/tags/安全/">安全</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/17/https详解/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/27/LeetCode-Perfect-Squares/" title="LeetCode - Perfect Squares" itemprop="url">LeetCode - Perfect Squares</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-03-27T02:41:50.000Z" itemprop="datePublished"> Published Mar 27 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="Problem_Description：">Problem Description：</h2>
<p>Given a positive integer n, find the least number of perfect square numbers (for example, 1, 4, 9, 16, …) which sum to n.<br>For example, given n = 12, return 3 because 12 = 4 + 4 + 4; given n = 13, return 2 because 13 = 4 + 9.</p>
<h2 id="Solution:">Solution:</h2>
<h3 id="Solution1:">Solution1:</h3>
<p>Dynamic Programming<br>Time Complexity: O(n*sqrt(n))<br>Space: O(n)</p>
<h3 id="Solution2:">Solution2:</h3>
<p>Number Theory</p>
<ul>
<li>Legendre’s three-square theorem </li>
<li>Lagrange’s four-square theorem</li>
</ul>
<p>Time Complexity: O(sqrt(n))<br>Space: O(1)</p>
<h2 id="Code">Code</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zane.algorithm.leetcode;</div><div class="line"></div><div class="line"><span class="javadoc">/**</span></div><div class="line"> * Author: luojinping</div><div class="line"> * Date: 15/9/23</div><div class="line"> * Time: 17:23</div><div class="line"> * &lt;p/&gt;</div><div class="line"> * &lt;p/&gt;</div><div class="line"> * Given a positive integer n, find the least number of perfect square numbers</div><div class="line"> * (for example, 1, 4, 9, 16, ...) which sum to n.</div><div class="line"> * For example, given n = 12, return 3 because 12 = 4 + 4 + 4; given n = 13,</div><div class="line"> * return 2 because 13 = 4 + 9.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PerfectSquares_279</span> </span>{</div><div class="line">    <span class="javadoc">/**</span></div><div class="line">     * cannot use greedy algorithm, counter example：</div><div class="line">     * 98=81+16+1=49+49</div><div class="line">     * 101=100+1=49+1+49+2</div><div class="line">     * 7=4+1+1+1</div><div class="line">     * 12=4+4+4=9+1+1+1</div><div class="line">     * 思路:</div><div class="line">     * 使用DP, dp[]数组记录历史使用最少平方数的情况.例如dp[5]=2,记录的是使用最少(1+4)平方数的数量,即2.</div><div class="line">     *</div><div class="line">     *<span class="javadoctag"> @param</span> n</div><div class="line">     *<span class="javadoctag"> @return</span></div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numSquares</span>(<span class="keyword">int</span> n) {</div><div class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">2</span>) {</div><div class="line">            <span class="keyword">return</span> n;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// record the least number of perfect numbers when index = i</span></div><div class="line">        <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</div><div class="line">        dp[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">        dp[<span class="number">1</span>] = <span class="number">1</span>;</div><div class="line">        dp[<span class="number">2</span>] = <span class="number">2</span>;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt;= n; i++) {</div><div class="line">            <span class="keyword">int</span> leastNum = i;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j * j &lt;= i; j++) {</div><div class="line">                leastNum = Math.min(leastNum, dp[i - j * j] + <span class="number">1</span>);</div><div class="line"></div><div class="line">            }</div><div class="line">            dp[i] = leastNum;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">return</span> dp[n];</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSquare</span>(<span class="keyword">int</span> n) {</div><div class="line">        <span class="keyword">int</span> sqrt_n = (<span class="keyword">int</span>) (Math.sqrt(n));</div><div class="line">        <span class="keyword">return</span> (sqrt_n * sqrt_n == n);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="javadoc">/**</span></div><div class="line">     * Legendre's three-square theorem:</div><div class="line">     * The three squares theorem tells you that a positive integer n can be represented as the sum</div><div class="line">     * of 3 squares (n = x^2 + y^2 + z^2) if and only if it is not of the form n = 4^a * (8 * b+7)</div><div class="line">     * &lt;p/&gt;</div><div class="line">     * Lagrange's four-square theorem:</div><div class="line">     * Every natural number can be represented as the sum of four integer squares:</div><div class="line">     * n= a^2 + b^2 + c^2 + d^2</div><div class="line">     * &lt;p/&gt;</div><div class="line">     * &lt;p/&gt;</div><div class="line">     * So the are only 4 possible results: 1, 2, 3, 4.</div><div class="line">     * &lt;p/&gt;</div><div class="line">     * Refer:</div><div class="line">     * https://leetcode.com/discuss/58056/summary-of-different-solutions-bfs-static-and-mathematics</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numSquaresByMath</span>(<span class="keyword">int</span> n) {</div><div class="line">        <span class="comment">// If n is a perfect square, return 1.</span></div><div class="line">        <span class="keyword">if</span> (isSquare(n)) {</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// The result is 4 if and only if n can be written in the</span></div><div class="line">        <span class="comment">// form of 4^k*(8*m + 7). Please refer to</span></div><div class="line">        <span class="comment">// Legendre's three-square theorem.</span></div><div class="line">        <span class="keyword">while</span> ((n & <span class="number">3</span>) == <span class="number">0</span>) <span class="comment">// n%4 == 0</span></div><div class="line">        {</div><div class="line">            n &gt;&gt;= <span class="number">2</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> ((n & <span class="number">7</span>) == <span class="number">7</span>) <span class="comment">// n%8 == 7</span></div><div class="line">        {</div><div class="line">            <span class="keyword">return</span> <span class="number">4</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Check whether 2 is the result.</span></div><div class="line">        <span class="keyword">int</span> sqrt_n = (<span class="keyword">int</span>) (Math.sqrt(n));</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= sqrt_n; i++) {</div><div class="line">            <span class="keyword">if</span> (isSquare(n - i * i)) {</div><div class="line">                <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">3</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) {</div><div class="line">        PerfectSquares_279 perfectSquares279 = <span class="keyword">new</span> PerfectSquares_279();</div><div class="line">        System.out.println(perfectSquares279.numSquares(<span class="number">4</span>));</div><div class="line">        System.out.println(perfectSquares279.numSquares(<span class="number">7</span>));</div><div class="line">        System.out.println(perfectSquares279.numSquares(<span class="number">12</span>));</div><div class="line">        System.out.println(perfectSquares279.numSquares(<span class="number">61</span>));</div><div class="line">        System.out.println(perfectSquares279.numSquares(<span class="number">100</span>));</div><div class="line">        System.out.println(perfectSquares279.numSquares(<span class="number">101</span>));</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="Refer:">Refer:</h2>
<blockquote>
<p><a href="https://leetcode.com/discuss/58056/summary-of-different-solutions-bfs-static-and-mathematics" target="_blank" rel="external">https://leetcode.com/discuss/58056/summary-of-different-solutions-bfs-static-and-mathematics</a></p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/算法/">算法</a><a href="/tags/LeetCode/">LeetCode</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/27/LeetCode-Perfect-Squares/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/26/LeetCode-The-Skyline-Problem/" title="LeetCode - The Skyline Problem" itemprop="url">LeetCode - The Skyline Problem</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-03-26T14:47:52.000Z" itemprop="datePublished"> Published Mar 26 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="Problem_Description">Problem Description</h2>
<p>A city’s skyline is the outer contour of the silhouette formed by all the buildings in that city when viewed from a distance. Now suppose you are given the locations and height of all the buildings as shown on a cityscape photo (Figure A), write a program to output the skyline formed by these buildings collectively (Figure B).</p>
<p> Buildings  Skyline Contour<br>The geometric information of each building is represented by a triplet of integers [Li, Ri, Hi], where Li and Ri are the x coordinates of the left and right edge of the ith building, respectively, and Hi is its height. It is guaranteed that 0 ≤ Li, Ri ≤ INT_MAX, 0 &lt; Hi ≤ INT_MAX, and Ri - Li &gt; 0. You may assume all buildings are perfect rectangles grounded on an absolutely flat surface at height 0.</p>
<p>For instance, the dimensions of all buildings in Figure A are recorded as: [ [2 9 10], [3 7 15], [5 12 12], [15 20 10], [19 24 8] ] .</p>
<p>The output is a list of “key points” (red dots in Figure B) in the format of [ [x1,y1], [x2, y2], [x3, y3], … ] that uniquely defines a skyline. A key point is the left endpoint of a horizontal line segment. Note that the last key point, where the rightmost building ends, is merely used to mark the termination of the skyline, and always has zero height. Also, the ground in between any two adjacent buildings should be considered part of the skyline contour.</p>
<p>For instance, the skyline in Figure B should be represented as:[ [2 10], [3 15], [7 12], [12 0], [15 10], [20 8], [24, 0] ].</p>
<p>Notes:</p>
<ul>
<li>The number of buildings in any input list is guaranteed to be in the range [0, 10000].</li>
<li>The input list is already sorted in ascending order by the left x position Li.</li>
<li>The output list must be sorted by the x position.<br>There must be no consecutive horizontal lines of equal height in the output skyline. For instance, […[2 3], [4 5], [7 5], [11 5], [12 7]…] is not acceptable; the three lines of height 5 should be merged into one in the final output as such: […[2 3], [4 5], [12 7], …]</li>
</ul>
<p><strong>problem link:</strong><br><a href="https://leetcode.com/problems/the-skyline-problem/" target="_blank" rel="external">https://leetcode.com/problems/the-skyline-problem/</a></p>
<h2 id="Solution">Solution</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">public class <span class="type">TheSkylineProblem_218</span> {</div><div class="line">    public <span class="type">List</span>&lt;<span class="type">int</span>[]&gt; getSkylineSimpleSolution(<span class="type">int</span>[][] buildings) {</div><div class="line">        <span class="type">List</span>&lt;<span class="type">int</span>[]&gt; <span class="literal">result</span> = new <span class="type">ArrayList</span>&lt;&gt;();</div><div class="line">        <span class="type">List</span>&lt;<span class="type">int</span>[]&gt; height = new <span class="type">ArrayList</span>&lt;&gt;();</div><div class="line"></div><div class="line">        // height &lt; <span class="number">0</span>: the height <span class="keyword">of</span> building started</div><div class="line">        // height &gt; <span class="number">0</span>: the height <span class="keyword">of</span> building ended</div><div class="line">        <span class="keyword">for</span> (<span class="type">int</span>[] b : buildings) {</div><div class="line">            height.add(new <span class="type">int</span>[]{b[<span class="number">0</span>], -b[<span class="number">2</span>]});</div><div class="line">            height.add(new <span class="type">int</span>[]{b[<span class="number">1</span>], b[<span class="number">2</span>]});</div><div class="line">        }</div><div class="line"></div><div class="line">        // sorted by x value, <span class="keyword">if</span> x equals then sorted by y value</div><div class="line">        <span class="type">Collections</span>.sort(height, (a, b) -&gt; {</div><div class="line">            <span class="keyword">if</span> (a[<span class="number">0</span>] != b[<span class="number">0</span>])</div><div class="line">                <span class="keyword">return</span> a[<span class="number">0</span>] - b[<span class="number">0</span>];</div><div class="line">            <span class="keyword">return</span> a[<span class="number">1</span>] - b[<span class="number">1</span>];</div><div class="line">        });</div><div class="line"></div><div class="line">        // record the height <span class="keyword">of</span> visited buildings by reverse order</div><div class="line">        <span class="type">Queue</span>&lt;<span class="type">Integer</span>&gt; pq = new <span class="type">PriorityQueue</span>&lt;&gt;((a, b) -&gt; (b - a));</div><div class="line">        pq.offer(<span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="type">int</span> prevHeight = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="type">int</span>[] h : height) {</div><div class="line">            <span class="keyword">if</span> (h[<span class="number">1</span>] &lt; <span class="number">0</span>) {</div><div class="line">                // save the height <span class="keyword">of</span> building</div><div class="line">                pq.offer(-h[<span class="number">1</span>]);</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                // remove the height <span class="keyword">of</span> building</div><div class="line">                pq.remove(h[<span class="number">1</span>]);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="type">int</span> curHeight = pq.peek();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (prevHeight != curHeight) {</div><div class="line">                // find the turn point</div><div class="line">                <span class="literal">result</span>.add(new <span class="type">int</span>[]{h[<span class="number">0</span>], curHeight});</div><div class="line">                prevHeight = curHeight;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="算法解释">算法解释</h2>
<h3 id="算法思路">算法思路</h3>
<ol>
<li>遍历所有的点，height用来存放每个顶点，左顶点的高度转为负数，右顶点的高度仍然是正数</li>
<li>对height数组排序，首先按x的值排序，当x的值相等时按z排序，这样保证了即使矩形的起点一样，也是最先处理最高的点。对于[{1,2,1},{1,2,2},{1,2,3}]这样的情况会优先处理{1,2,3}这个点。</li>
<li>使用优先级队列pq来保存当前最近buildings的高度，这个结构很重要！</li>
<li>遍历height数组，碰到左顶点时，将高度放入pq中，否则，碰到右顶点时则将高度从pq从移除。这样做的好处是，每次走完一个矩形时，高度能回归到之前的buildings的高度。</li>
<li>获取当前的最高高度，因为如果比当前矮的话，是不需要放入拐点中的，这点很重要！</li>
<li>如果当前的最高高度和之前的高度不一致，说明出现了拐点。**如果当前的最高高度矮于之前的值，说明之前的很高的建筑遇到了它的右顶点从而被移除了，所以目前的最高高度即使矮于之前的点，但是是新的隔离的building了，所以可以加入。那么如果高呢？当前高度比之前高，那肯定会是拐点了。</li>
</ol>
<h2 id="总结">总结</h2>
<p>几个关键点：</p>
<ol>
<li>对顶点进行排序保存，对左右顶点根据正负号来加以区分</li>
<li>使用一个优先级队列来保存目前最高的建筑</li>
<li>碰到右顶点时消除目前的建筑高度</li>
<li>根据之前的高度和处理目前顶点以后(可能是加入了高度也可能是消除了之前的高度)的高度，对两者进行比较来找到拐点</li>
</ol>
<h2 id="Reference">Reference</h2>
<blockquote>
<p><a href="https://leetcode.com/discuss/54201/short-java-solution" target="_blank" rel="external">https://leetcode.com/discuss/54201/short-java-solution</a></p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/算法/">算法</a><a href="/tags/LeetCode/">LeetCode</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/26/LeetCode-The-Skyline-Problem/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/03/扔鸡蛋测楼层/" title="扔鸡蛋测楼层" itemprop="url">扔鸡蛋测楼层</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-03-03T12:26:36.000Z" itemprop="datePublished"> Published Mar 3 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="扔瓶子测楼层">扔瓶子测楼层</h2>
<p>一栋楼有n层，需要测试某种材质的玻璃瓶从哪一层掉下来恰好会碎。现在仅有两个这样的瓶子。请问怎样仍才能最快的测出楼层的临界值？</p>
<h2 id="A-_只用一个瓶子从第一层扔到第n层">A. 只用一个瓶子从第一层扔到第n层</h2>
<p>找到临界值的扔瓶子次数的期望为每一层的期望次数之和</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E(x) = <span class="number">1</span>/n * <span class="number">1</span> + <span class="number">1</span>/n * <span class="number">2</span> + <span class="number">1</span>/n * <span class="number">3</span> + <span class="keyword">...</span> + <span class="number">1</span>/n * n = (<span class="number">1</span>+n)/<span class="number">2</span></div></pre></td></tr></table></figure>


<p>所以时间复杂度是O(n)</p>
<h2 id="B-_用贪心的思维">B. 用贪心的思维</h2>
<p>第一个瓶子从第1层开始扔，每次层数翻倍，依次为，1，2，4，8，16，直至在第 2^k 层碎掉。<br>第二个瓶子从第 2^(k-1) 层开始扔，直至第 2^k 层为止，中间肯定能找到临界值。<br>所以时间复杂度是O(lgn)</p>
<h2 id="C-_用二分法">C. 用二分法</h2>
<p>第一个瓶子每次以(i, j)为区间，扔的位置为(i+j)/2, 初始情况, i=0,j=n, 如果瓶子没碎，则i=j，直至碎掉。<br>第二个瓶子从第 i 层开始扔，直至第 j 层为止，中间肯定能找到临界值。</p>
<p>对于第 i 层，扔的情况为：</p>
<ul>
<li>第一个瓶子：n/2, $/2+n/4 i, n/2+n/4+n/8</li>
<li>第二个瓶子：n/2+n/4, (n/2+n/k+1), …, i</li>
</ul>
<p>显而易见，时间复杂度是O(n)</p>
<h2 id="D-_数学推算">D. 数学推算</h2>
<p>这个题目是需要最快的找出临界值，可以转换为，即使在最坏的情况下，也能最快地找出临界值。</p>
<p>我们先假设最坏情况下，瓶子下落次数为x，即我们为了找出N，一共用瓶子做了x次的实验。 </p>
<p>那么，我们第一次应该在哪层楼往下扔瓶子呢？</p>
<p>先让我们假设第一次是在第y层楼扔的瓶子，如果第一个瓶子在第一次扔就碎了，我们就只剩下一个瓶子，要用它准确地找出N，只能从第一层向上，一层一层的往上测试，直到它摔坏为止，答案就出来了。</p>
<p>由于第一个瓶子在第y层就摔破了，所以最坏的情况是第二个瓶子要把第1到第y-1层的楼都测试一遍，最后得出结果，噢，原来瓶子在第y-1层才能摔破(或是在第y-1层仍没摔破，答案就是第y层。) 这样一来测试次数是1+(y-1)=x，即第一次测试要在第x层。</p>
<p>OK，那如果第一次测试鸡蛋没摔破呢，那N肯定要比x大，要继续往上找，需要在哪一层扔呢？我们可以模仿前面的操作，如果第一个瓶子在第二次测试中摔破了，那么第二个瓶子的测试次数就只剩下x-2次了(第一个瓶子已经用了2次)。这样一来，第二次扔瓶子的楼层和第一次扔瓶子的楼层之间就隔着x-2层。 </p>
<p>我们再回过头来看一看，第一次扔瓶子的楼层在第x层，第1层到第x层间共x层；第1次扔鸡蛋的楼层到第2次扔瓶子的楼层间共有x-1层(包含第2次扔瓶子的那一层)，同理继续往下，我们可以得出，第2次扔瓶子的楼层到第3次扔瓶子的楼层间共有x-2层，最后把这些互不包含的区间数加起来，应该大于等于总共的楼层数量100，即</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">x + (x-<span class="number">1</span>) + (x-<span class="number">2</span>) + <span class="keyword">...</span> + <span class="number">1</span> &gt;= <span class="number">100</span></div><div class="line">(x+<span class="number">1</span>)*x/<span class="number">2</span> &gt;= <span class="number">100</span></div><div class="line">得出答案是<span class="number">14</span></div></pre></td></tr></table></figure>

<p>即我先用第1个瓶子在以下序列表示的楼层数不断地向上测试，直到它摔破。 再用第2个瓶子从上一个没摔破的序列数的下一层开始，向上测试，即可保证在最坏情况下也只需要测试14次，就能用2个瓶子找出从哪一层开始，往下扔鸡蛋，瓶子就会摔破。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">14, 27, 39, 50, 60, 69, 77, 84, 90, 95, 99, 100</div></pre></td></tr></table></figure>

<h2 id="E-_DP的解法">E. DP的解法</h2>
<p>假设f(n)表示从第n层楼扔下鸡蛋，没有摔碎的最少尝试次数。第一个鸡蛋，可能的落下位置[1,n],第一个鸡蛋从第i层扔下，有两种情况：</p>
<ul>
<li>碎了，第二个鸡蛋，需要从第一层开始试验，有i-1次机会</li>
<li>没碎，两个鸡蛋，还有n-i层。这个就是子问题了f(n-i)</li>
</ul>
<p>所以，当第一个鸡蛋，由第i个位置落下的时候，要尝试的次数为 1 + max{i - 1, f(n - i)}，那么对于每一个i，尝试次数最少的，就是f(n)的值。<br>状态转移方程如下： </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">f</span><span class="params">(n)</span> = <span class="title">min</span>{1 + <span class="title">max</span>{<span class="title">i</span> - 1, <span class="title">f</span><span class="params">(n - <span class="number">1</span>)</span>}}</span></div></pre></td></tr></table></figure>

<p>其中: i的范围为[1, n], f(1) = 1.</p>
<h2 id="F-_推广到一般化的问题">F. 推广到一般化的问题</h2>
<p>为n层楼，m个鸡蛋。<br>如下分析： 假设f(n,m)表示n层楼、m个鸡蛋时找到最高楼层的最少尝试次数。当第一个鸡蛋从第i层扔下，有两种情况：</p>
<ul>
<li>碎了，还剩m-1个鸡蛋，为确定下面楼层中的安全楼层，还需要f(i-1,m-1)次，找到子问题</li>
<li>不碎，上面还有n-i层，还需要f(n-i,m)次，又一个子问题。</li>
</ul>
<p>状态转移方程如下： </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">f</span><span class="params">(n, m)</span> = <span class="title">min</span>{1 + <span class="title">max</span>{<span class="title">f</span><span class="params">(n - <span class="number">1</span>, m - <span class="number">1</span>)</span>, <span class="title">f</span><span class="params">(n - i, m)</span>}}</span></div></pre></td></tr></table></figure>

<p>其中： i为[1, n], f(i, 1) = 1</p>
<h2 id="Reference">Reference</h2>
<blockquote>
<p><a href="http://www.cricode.com/3558.html" target="_blank" rel="external">http://www.cricode.com/3558.html</a><br><a href="https://gist.github.com/sing1ee/5971946" target="_blank" rel="external">https://gist.github.com/sing1ee/5971946</a></p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/算法/">算法</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/03/03/扔鸡蛋测楼层/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/02/27/快排算法/" title="快排算法" itemprop="url">快排算法</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://luojinping.com/about" title="Jinping Luo" target="_blank" itemprop="author">Jinping Luo</a>
		
  <p class="article-time">
    <time datetime="2016-02-27T02:52:46.000Z" itemprop="datePublished"> Published Feb 27 2016</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="快速排序的思路">快速排序的思路</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">algorithm quicksort(<span class="literal">A</span>, lo, hi) is</div><div class="line">    <span class="keyword">if</span> lo &lt; hi then</div><div class="line">        p := partition(<span class="literal">A</span>, lo, hi)</div><div class="line">        quicksort(<span class="literal">A</span>, lo, p – <span class="number">1</span>)</div><div class="line">        quicksort(<span class="literal">A</span>, p + <span class="number">1</span>, hi)</div></pre></td></tr></table></figure>

<h2 id="快速排序的partition方式">快速排序的partition方式</h2>
<p>一种是Lomuto partition scheme，另外一种是Hoare partition scheme。</p>
<h2 id="Lomuto_partition">Lomuto partition</h2>
<p>This scheme is attributed to Nico Lomuto and popularized by Bentley in his book</p>
<h3 id="lomuto的partition实现方式">lomuto的partition实现方式</h3>
<p>i指示最前面的大于pivot的元素位置，j从前往后滑动来调整元素位置。每次j碰到小于pivot的元素，则swap i位置的元素和j位置的元素，再i指向下一个大于pivot的元素。<br>最后，记得swap i位置的元素和最末尾的元素。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">lomutoPartition</span>(<span class="keyword">int</span> nums[], <span class="keyword">int</span> lo, <span class="keyword">int</span> hi) {</div><div class="line">        <span class="keyword">int</span> pivot = nums[hi];</div><div class="line">        <span class="keyword">int</span> i = lo;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = lo; j &lt; hi; j++) {</div><div class="line">            <span class="keyword">if</span> (nums[j] &lt;= pivot) {</div><div class="line">                swap(nums, i, j);</div><div class="line">                i++;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        swap(nums, i, hi); <span class="comment">// replace the guard element</span></div><div class="line">        <span class="keyword">return</span> i;</div><div class="line">    }</div></pre></td></tr></table></figure>

<h2 id="Hoare_partition_scheme">Hoare partition scheme</h2>
<p>The original partition scheme described by C.A.R. Hoare uses two indices that start at the ends of the array being partitioned, then move toward each other, until they detect an inversion.</p>
<p><strong>Hoare’s scheme is more efficient than Lomuto’s partition scheme because it does three times fewer swaps on average, and it creates efficient partitions even when all values are equal.</strong></p>
<h3 id="hoare的partition实现方式">hoare的partition实现方式</h3>
<p>i从前往后找到大于pivot的元素，j从后往前找到小于pivot的元素，然后两者swap.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">hoarePartition</span>(<span class="keyword">int</span> nums[], <span class="keyword">int</span> lo, <span class="keyword">int</span> hi) {</div><div class="line">        <span class="keyword">int</span> pivot = nums[lo];</div><div class="line">        <span class="keyword">int</span> i = lo, j = hi;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">            <span class="keyword">while</span> (nums[i] &lt; pivot) {</div><div class="line">                i++;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">while</span> (nums[j] &gt;= pivot) {</div><div class="line">                j--;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (i &gt;= j) {</div><div class="line">                <span class="keyword">return</span> j;</div><div class="line">            }</div><div class="line"></div><div class="line">            swap(nums, i, j);</div><div class="line">        }</div><div class="line">    }</div></pre></td></tr></table></figure>


        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/算法/">算法</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/02/27/快排算法/#disqus_thread" class="comments-count-link">Comments</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/java/" title="java">java<sup>14</sup></a></li>
		
			<li><a href="/tags/算法/" title="算法">算法<sup>8</sup></a></li>
		
			<li><a href="/tags/多线程/" title="多线程">多线程<sup>6</sup></a></li>
		
			<li><a href="/tags/调试/" title="调试">调试<sup>3</sup></a></li>
		
			<li><a href="/tags/coursera/" title="coursera">coursera<sup>2</sup></a></li>
		
			<li><a href="/tags/网络/" title="网络">网络<sup>2</sup></a></li>
		
			<li><a href="/tags/LeetCode/" title="LeetCode">LeetCode<sup>2</sup></a></li>
		
			<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
		
			<li><a href="/tags/机器学习/" title="机器学习">机器学习<sup>2</sup></a></li>
		
			<li><a href="/tags/Spring/" title="Spring">Spring<sup>1</sup></a></li>
		
			<li><a href="/tags/安全/" title="安全">安全<sup>1</sup></a></li>
		
			<li><a href="/tags/spark/" title="spark">spark<sup>1</sup></a></li>
		
			<li><a href="/tags/skill/" title="skill">skill<sup>1</sup></a></li>
		
			<li><a href="/tags/Spark/" title="Spark">Spark<sup>1</sup></a></li>
		
			<li><a href="/tags/分布式/" title="分布式">分布式<sup>1</sup></a></li>
		
			<li><a href="/tags/并发/" title="并发">并发<sup>1</sup></a></li>
		
			<li><a href="/tags/总结/" title="总结">总结<sup>1</sup></a></li>
		
			<li><a href="/tags/数据挖掘/" title="数据挖掘">数据挖掘<sup>1</sup></a></li>
		
			<li><a href="/tags/test/" title="test">test<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m ljp215 Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Pacman">Jacman</a> © 2017 
		
		<a href="http://luojinping.com/about" target="_blank" title="Jinping Luo">Jinping Luo</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>





<script type="text/javascript">

var disqus_shortname = 'zane215';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fnull' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<!-- MathJax End -->

  </body>
 </html>
